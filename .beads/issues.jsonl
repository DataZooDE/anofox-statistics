{"id":"anofox-statistics-kkk","title":"Implement *_fit_predict_by table macros for regression functions","description":"## Overview\n\nImplement table macros for regression fit-predict functions following the pattern established by `ts_forecast_by` in anofox-forecast extension. These macros will provide a user-friendly SQL interface for running regression predictions on grouped data.\n\n## Background\n\nThe anofox-forecast extension provides `ts_forecast_by` as a table macro that:\n- Wraps the lower-level `_ts_forecast()` scalar function\n- Provides column-by-name interface (unquoted identifiers)\n- Handles grouping/ungrouping automatically\n- Unnests results into long format (one row per prediction)\n- Uses `query_table(source::VARCHAR)` for dynamic table references\n\n## Proposed Functions\n\nCreate table macros for each `*_fit_predict_agg` function:\n\n| Table Macro | Wraps |\n|-------------|-------|\n| `ols_fit_predict_by` | `ols_fit_predict_agg` |\n| `ridge_fit_predict_by` | `ridge_fit_predict_agg` |\n| `elasticnet_fit_predict_by` | `elasticnet_fit_predict_agg` |\n| `wls_fit_predict_by` | `wls_fit_predict_agg` |\n| `rls_fit_predict_by` | `rls_fit_predict_agg` |\n| `bls_fit_predict_by` | `bls_fit_predict_agg` |\n| `alm_fit_predict_by` | `alm_fit_predict_agg` |\n| `poisson_fit_predict_by` | `poisson_fit_predict_agg` |\n\n## Proposed Signature\n\n```sql\nols_fit_predict_by(\n    source,      -- VARCHAR: table name\n    group_col,   -- IDENTIFIER: grouping column\n    y_col,       -- IDENTIFIER: target variable\n    x_cols,      -- LIST or IDENTIFIER[]: feature columns\n    options      -- MAP: optional parameters\n) -\u003e TABLE\n```\n\n## Expected Output Format (Long Format)\n\n| Column | Type | Description |\n|--------|------|-------------|\n| group_id | ANY | Group identifier |\n| row_idx | INTEGER | Original row index |\n| y | DOUBLE | Original y value (NULL for OOS) |\n| x | LIST(DOUBLE) | Feature values |\n| yhat | DOUBLE | Predicted value |\n| yhat_lower | DOUBLE | Lower prediction interval |\n| yhat_upper | DOUBLE | Upper prediction interval |\n| is_training | BOOLEAN | Training vs OOS indicator |\n\n## Implementation Pattern\n\nFollow the pattern from `ts_forecast_by` in anofox-forecast:\n\n1. **SQL Macro Definition** in `src/macros/`:\n   ```sql\n   WITH predictions AS (\n       SELECT\n           group_col AS group_id,\n           *_fit_predict_agg(y_col, [x_cols...], options) AS pred\n       FROM query_table(source::VARCHAR)\n       GROUP BY group_col\n   )\n   SELECT\n       group_id,\n       UNNEST(pred) AS prediction\n   FROM predictions\n   ```\n\n2. **C++ Registration** following `TsTableMacro` struct pattern\n\n3. **Test Coverage** for each macro\n\n## Reference Implementation\n\nSee anofox-forecast:\n- `src/macros/ts_macros.cpp` (lines 466-555)\n- `test/sql/ts_forecast_by.test`\n\n## Acceptance Criteria\n\n- [ ] All 8 table macros implemented\n- [ ] Column-by-name interface (unquoted identifiers)\n- [ ] Long format output with unnested predictions\n- [ ] Options MAP passed through to underlying aggregate\n- [ ] Comprehensive test coverage\n- [ ] Documentation in API_REFERENCE.md","status":"open","priority":2,"issue_type":"feature","created_at":"2026-01-08T19:12:11.516701682+01:00","created_by":"simonm","updated_at":"2026-01-08T19:12:11.516701682+01:00"}
