cmake_minimum_required(VERSION 3.20)

# Standalone extension build for anofox_statistics
project(anofox_statistics_extension)

set(CMAKE_CXX_STANDARD 11)

# Find DuckDB
find_package(DuckDB REQUIRED)

# Extension sources - Phase 1 & 2 only
set(EXTENSION_SOURCES
    src/anofox_extension.cpp
    src/bridge/type_converter.cpp
    src/bridge/memory_manager.cpp
    src/functions/ols_fit.cpp
    src/functions/ols_predict.cpp
    src/functions/ols_metrics.cpp
    src/functions/ridge_fit.cpp
    src/functions/wls_fit.cpp
    src/functions/elastic_net_fit.cpp
)

# Include directories
include_directories(src/include)
include_directories(${DUCKDB_INCLUDE_DIR})

# Set up AnofoxStatistics library configuration
set(ANOFOX_STATS_DIR "${CMAKE_CURRENT_SOURCE_DIR}/../anofox-statistics")
set(ANOFOX_STATS_BUILD_DIR "${ANOFOX_STATS_DIR}/build")

# Include AnofoxStatistics headers
include_directories("${ANOFOX_STATS_DIR}/src")

# Eigen3 configuration (header-only library)
set(EIGEN3_DIR "/tmp/eigen-3.4.0")
if(EXISTS "${EIGEN3_DIR}")
    include_directories(${EIGEN3_DIR})
else()
    find_package(Eigen3 REQUIRED)
    include_directories(${EIGEN3_INCLUDE_DIR})
endif()

# Build as loadable extension
add_library(anofox_statistics SHARED ${EXTENSION_SOURCES})
target_link_libraries(anofox_statistics PRIVATE duckdb)
set_target_properties(anofox_statistics PROPERTIES PREFIX "")
set_target_properties(anofox_statistics PROPERTIES SUFFIX ".duckdb_extension")

# Install to standard location
install(TARGETS anofox_statistics DESTINATION .)
