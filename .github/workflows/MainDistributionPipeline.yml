#
# This workflow calls the main distribution pipeline from DuckDB to build, test and (optionally) release the extension
#
name: Main Extension Distribution Pipeline
on:
  push:
  pull_request:
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}-${{ github.head_ref || '' }}-${{ github.base_ref || '' }}-${{ github.ref != 'refs/heads/main' && github.sha || '' }}
  cancel-in-progress: true

jobs:
  duckdb-stable-build:
    name: Build extension binaries
    uses: duckdb/extension-ci-tools/.github/workflows/_extension_distribution.yml@v1.4.2
    with:
      duckdb_version: v1.4.2
      ci_tools_version: v1.4.2
      extension_name: anofox_statistics

  code-quality-check:
    name: Code Quality Check
    uses: duckdb/extension-ci-tools/.github/workflows/_extension_code_quality.yml@v1.4.2
    with:
      duckdb_version: v1.4.2
      ci_tools_version: v1.4.2
      extension_name: anofox_statistics
      format_checks: 'format;tidy'

  build-and-test-libanostat:
    name: Build and unit test libanostat
    runs-on: ubuntu-24.04
    env:
      CC: gcc
      CXX: g++
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: 'recursive'

      - name: Install build dependencies
        run: |
          sudo apt-get update -y -qq
          sudo apt-get install -y -qq \
            build-essential \
            cmake \
            ninja-build \
            git \
            curl \
            tar \
            zip \
            unzip \
            pkg-config \
            python3 \
            python3-pip \
            autoconf \
            automake \
            autoconf-archive

      - name: Setup vcpkg
        run: |
          mkdir -p local_vcpkg_installation
          cd local_vcpkg_installation
          git init
          git remote add origin https://github.com/microsoft/vcpkg.git
          git fetch origin ce613c41372b23b1f51333815feb3edd87ef8a8b
          git checkout ce613c41372b23b1f51333815feb3edd87ef8a8b
          ./bootstrap-vcpkg.sh
          echo "VCPKG_ROOT=${{ github.workspace }}/local_vcpkg_installation" >> $GITHUB_ENV
          echo "VCPKG_TOOLCHAIN_PATH=${{ github.workspace }}/local_vcpkg_installation/scripts/buildsystems/vcpkg.cmake" >> $GITHUB_ENV
          echo "${{ github.workspace }}/local_vcpkg_installation" >> $GITHUB_PATH

      - name: Verify build tools
        run: |
          which ninja
          ninja --version
          which g++
          g++ --version
          which cmake
          cmake --version

      - name: Verify vcpkg
        run: |
          $VCPKG_ROOT/vcpkg version
          $VCPKG_ROOT/vcpkg list

      - name: Configure libanostat
        working-directory: libanostat
        run: |
          cmake -B build -S . \
            -DCMAKE_TOOLCHAIN_FILE=$VCPKG_TOOLCHAIN_PATH \
            -DCMAKE_MAKE_PROGRAM=$(which ninja) \
            -DBUILD_TESTING=ON \
            -G Ninja

      - name: Build libanostat
        working-directory: libanostat
        run: |
          cmake --build build --config Release -j$(nproc)

      - name: Run libanostat tests
        working-directory: libanostat
        run: |
          ctest --test-dir build --output-on-failure --parallel $(nproc)
