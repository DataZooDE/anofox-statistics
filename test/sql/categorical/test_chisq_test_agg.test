# name: test/sql/categorical/test_chisq_test_agg.test
# description: Test chisq_test_agg aggregate function (Chi-square test for independence)
# group: [categorical]

require anofox_statistics

# =============================================================================
# SETUP: Create 2x2 contingency table [[10, 20], [30, 40]]
# R: chisq.test(matrix(c(10,30,20,40), nrow=2), correct=FALSE)
# Expected: X-squared = 0.794, df = 1, p = 0.373
# =============================================================================

statement ok
CREATE TABLE contingency_2x2 AS
SELECT * FROM (VALUES
    (0, 0), (0, 0), (0, 0), (0, 0), (0, 0), (0, 0), (0, 0), (0, 0), (0, 0), (0, 0),
    (0, 1), (0, 1), (0, 1), (0, 1), (0, 1), (0, 1), (0, 1), (0, 1), (0, 1), (0, 1),
    (0, 1), (0, 1), (0, 1), (0, 1), (0, 1), (0, 1), (0, 1), (0, 1), (0, 1), (0, 1),
    (1, 0), (1, 0), (1, 0), (1, 0), (1, 0), (1, 0), (1, 0), (1, 0), (1, 0), (1, 0),
    (1, 0), (1, 0), (1, 0), (1, 0), (1, 0), (1, 0), (1, 0), (1, 0), (1, 0), (1, 0),
    (1, 0), (1, 0), (1, 0), (1, 0), (1, 0), (1, 0), (1, 0), (1, 0), (1, 0), (1, 0),
    (1, 1), (1, 1), (1, 1), (1, 1), (1, 1), (1, 1), (1, 1), (1, 1), (1, 1), (1, 1),
    (1, 1), (1, 1), (1, 1), (1, 1), (1, 1), (1, 1), (1, 1), (1, 1), (1, 1), (1, 1),
    (1, 1), (1, 1), (1, 1), (1, 1), (1, 1), (1, 1), (1, 1), (1, 1), (1, 1), (1, 1),
    (1, 1), (1, 1), (1, 1), (1, 1), (1, 1), (1, 1), (1, 1), (1, 1), (1, 1), (1, 1)
) AS t(row_var, col_var);

# =============================================================================
# TEST 1: Basic chi-square returns valid result structure
# =============================================================================

query I
SELECT (chisq_test_agg(row_var, col_var)).statistic IS NOT NULL FROM contingency_2x2;
----
true

query I
SELECT (chisq_test_agg(row_var, col_var)).p_value IS NOT NULL FROM contingency_2x2;
----
true

query I
SELECT (chisq_test_agg(row_var, col_var)).df IS NOT NULL FROM contingency_2x2;
----
true

query I
SELECT (chisq_test_agg(row_var, col_var)).method IS NOT NULL FROM contingency_2x2;
----
true

# =============================================================================
# TEST 2: Chi-square statistic matches R validation (~0.794)
# =============================================================================

query I
SELECT ABS((chisq_test_agg(row_var, col_var)).statistic - 0.794) < 0.01 FROM contingency_2x2;
----
true

# =============================================================================
# TEST 3: Degrees of freedom = (rows-1) * (cols-1) = 1
# =============================================================================

query I
SELECT (chisq_test_agg(row_var, col_var)).df = 1 FROM contingency_2x2;
----
true

# =============================================================================
# TEST 4: No significant association (p > 0.05)
# =============================================================================

query I
SELECT (chisq_test_agg(row_var, col_var)).p_value > 0.05 FROM contingency_2x2;
----
true

# =============================================================================
# TEST 5: Significant association (clear pattern)
# =============================================================================

statement ok
CREATE TABLE strong_assoc AS
SELECT * FROM (VALUES
    (0, 0), (0, 0), (0, 0), (0, 0), (0, 0), (0, 0), (0, 0), (0, 0), (0, 0), (0, 0),
    (0, 0), (0, 0), (0, 0), (0, 0), (0, 0), (0, 0), (0, 0), (0, 0), (0, 0), (0, 0),
    (0, 0), (0, 0), (0, 0), (0, 0), (0, 0), (0, 0), (0, 0), (0, 0), (0, 0), (0, 0),
    (0, 0), (0, 0), (0, 0), (0, 0), (0, 0), (0, 0), (0, 0), (0, 0), (0, 0), (0, 0),
    (0, 0), (0, 0), (0, 0), (0, 0), (0, 0),
    (0, 1), (0, 1), (0, 1), (0, 1), (0, 1),
    (1, 0), (1, 0), (1, 0), (1, 0), (1, 0),
    (1, 1), (1, 1), (1, 1), (1, 1), (1, 1), (1, 1), (1, 1), (1, 1), (1, 1), (1, 1),
    (1, 1), (1, 1), (1, 1), (1, 1), (1, 1), (1, 1), (1, 1), (1, 1), (1, 1), (1, 1),
    (1, 1), (1, 1), (1, 1), (1, 1), (1, 1), (1, 1), (1, 1), (1, 1), (1, 1), (1, 1),
    (1, 1), (1, 1), (1, 1), (1, 1), (1, 1), (1, 1), (1, 1), (1, 1), (1, 1), (1, 1),
    (1, 1), (1, 1), (1, 1), (1, 1), (1, 1)
) AS t(row_var, col_var);

query I
SELECT (chisq_test_agg(row_var, col_var)).p_value < 0.001 FROM strong_assoc;
----
true

# =============================================================================
# TEST 6: 3x3 contingency table - df = 4
# =============================================================================

statement ok
CREATE TABLE contingency_3x3 AS
SELECT * FROM (VALUES
    (0, 0), (0, 0), (0, 0), (0, 0), (0, 0), (0, 0), (0, 0), (0, 0), (0, 0), (0, 0),
    (0, 1), (0, 1), (0, 1), (0, 1), (0, 1), (0, 1), (0, 1), (0, 1), (0, 1), (0, 1),
    (0, 1), (0, 1), (0, 1), (0, 1), (0, 1), (0, 1), (0, 1), (0, 1), (0, 1), (0, 1),
    (0, 2), (0, 2), (0, 2), (0, 2), (0, 2), (0, 2), (0, 2), (0, 2), (0, 2), (0, 2),
    (0, 2), (0, 2), (0, 2), (0, 2), (0, 2), (0, 2), (0, 2), (0, 2), (0, 2), (0, 2),
    (0, 2), (0, 2), (0, 2), (0, 2), (0, 2), (0, 2), (0, 2), (0, 2), (0, 2), (0, 2),
    (1, 0), (1, 0), (1, 0), (1, 0), (1, 0), (1, 0), (1, 0), (1, 0), (1, 0), (1, 0),
    (1, 0), (1, 0), (1, 0), (1, 0), (1, 0),
    (1, 1), (1, 1), (1, 1), (1, 1), (1, 1), (1, 1), (1, 1), (1, 1), (1, 1), (1, 1),
    (1, 1), (1, 1), (1, 1), (1, 1), (1, 1), (1, 1), (1, 1), (1, 1), (1, 1), (1, 1),
    (1, 1), (1, 1), (1, 1), (1, 1), (1, 1),
    (1, 2), (1, 2), (1, 2), (1, 2), (1, 2), (1, 2), (1, 2), (1, 2), (1, 2), (1, 2),
    (1, 2), (1, 2), (1, 2), (1, 2), (1, 2), (1, 2), (1, 2), (1, 2), (1, 2), (1, 2),
    (1, 2), (1, 2), (1, 2), (1, 2), (1, 2), (1, 2), (1, 2), (1, 2), (1, 2), (1, 2),
    (1, 2), (1, 2), (1, 2), (1, 2), (1, 2),
    (2, 0), (2, 0), (2, 0), (2, 0), (2, 0), (2, 0), (2, 0), (2, 0), (2, 0), (2, 0),
    (2, 0), (2, 0), (2, 0), (2, 0), (2, 0), (2, 0), (2, 0), (2, 0), (2, 0), (2, 0),
    (2, 1), (2, 1), (2, 1), (2, 1), (2, 1), (2, 1), (2, 1), (2, 1), (2, 1), (2, 1),
    (2, 1), (2, 1), (2, 1), (2, 1), (2, 1), (2, 1), (2, 1), (2, 1), (2, 1), (2, 1),
    (2, 1), (2, 1), (2, 1), (2, 1), (2, 1), (2, 1), (2, 1), (2, 1), (2, 1), (2, 1),
    (2, 2), (2, 2), (2, 2), (2, 2), (2, 2), (2, 2), (2, 2), (2, 2), (2, 2), (2, 2),
    (2, 2), (2, 2), (2, 2), (2, 2), (2, 2), (2, 2), (2, 2), (2, 2), (2, 2), (2, 2),
    (2, 2), (2, 2), (2, 2), (2, 2), (2, 2), (2, 2), (2, 2), (2, 2), (2, 2), (2, 2),
    (2, 2), (2, 2), (2, 2), (2, 2), (2, 2), (2, 2), (2, 2), (2, 2), (2, 2), (2, 2)
) AS t(row_var, col_var);

query I
SELECT (chisq_test_agg(row_var, col_var)).df = 4 FROM contingency_3x3;
----
true

# =============================================================================
# TEST 7: GROUP BY partitioning
# =============================================================================

statement ok
CREATE TABLE grouped_data AS
SELECT * FROM (VALUES
    ('A', 0, 0), ('A', 0, 0), ('A', 0, 0), ('A', 0, 0), ('A', 0, 0),
    ('A', 0, 0), ('A', 0, 0), ('A', 0, 0), ('A', 0, 0), ('A', 0, 0),
    ('A', 0, 1), ('A', 0, 1),
    ('A', 1, 0), ('A', 1, 0),
    ('A', 1, 1), ('A', 1, 1), ('A', 1, 1), ('A', 1, 1), ('A', 1, 1),
    ('A', 1, 1), ('A', 1, 1), ('A', 1, 1), ('A', 1, 1), ('A', 1, 1),
    ('B', 0, 0), ('B', 0, 0), ('B', 0, 0), ('B', 0, 0), ('B', 0, 0),
    ('B', 0, 1), ('B', 0, 1), ('B', 0, 1), ('B', 0, 1), ('B', 0, 1),
    ('B', 1, 0), ('B', 1, 0), ('B', 1, 0), ('B', 1, 0), ('B', 1, 0),
    ('B', 1, 1), ('B', 1, 1), ('B', 1, 1), ('B', 1, 1), ('B', 1, 1)
) AS t(category, row_var, col_var);

query TI
SELECT category, (chisq_test_agg(row_var, col_var)).p_value < 0.05 AS significant
FROM grouped_data
GROUP BY category
ORDER BY category;
----
A	true
B	false

# =============================================================================
# TEST 8: Alias verification (anofox_stats_chisq_test_agg)
# =============================================================================

query I
SELECT (anofox_stats_chisq_test_agg(row_var, col_var)).statistic IS NOT NULL FROM contingency_2x2;
----
true

# =============================================================================
# CLEANUP
# =============================================================================

statement ok
DROP TABLE IF EXISTS contingency_2x2;

statement ok
DROP TABLE IF EXISTS strong_assoc;

statement ok
DROP TABLE IF EXISTS contingency_3x3;

statement ok
DROP TABLE IF EXISTS grouped_data;
