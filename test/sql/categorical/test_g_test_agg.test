# name: test/sql/categorical/test_g_test_agg.test
# description: Test g_test_agg aggregate function (G-test / log-likelihood ratio test)
# group: [categorical]

require anofox_statistics

# =============================================================================
# SETUP: Create 2x2 contingency table data
# =============================================================================

statement ok
CREATE TABLE g_test_data AS
SELECT * FROM (VALUES
    (0, 0), (0, 0), (0, 0), (0, 0), (0, 0), (0, 0), (0, 0), (0, 0), (0, 0), (0, 0),
    (0, 1), (0, 1), (0, 1), (0, 1), (0, 1), (0, 1), (0, 1), (0, 1), (0, 1), (0, 1),
    (0, 1), (0, 1), (0, 1), (0, 1), (0, 1), (0, 1), (0, 1), (0, 1), (0, 1), (0, 1),
    (1, 0), (1, 0), (1, 0), (1, 0), (1, 0), (1, 0), (1, 0), (1, 0), (1, 0), (1, 0),
    (1, 0), (1, 0), (1, 0), (1, 0), (1, 0), (1, 0), (1, 0), (1, 0), (1, 0), (1, 0),
    (1, 0), (1, 0), (1, 0), (1, 0), (1, 0), (1, 0), (1, 0), (1, 0), (1, 0), (1, 0),
    (1, 1), (1, 1), (1, 1), (1, 1), (1, 1), (1, 1), (1, 1), (1, 1), (1, 1), (1, 1),
    (1, 1), (1, 1), (1, 1), (1, 1), (1, 1), (1, 1), (1, 1), (1, 1), (1, 1), (1, 1),
    (1, 1), (1, 1), (1, 1), (1, 1), (1, 1), (1, 1), (1, 1), (1, 1), (1, 1), (1, 1),
    (1, 1), (1, 1), (1, 1), (1, 1), (1, 1), (1, 1), (1, 1), (1, 1), (1, 1), (1, 1)
) AS t(row_var, col_var);

# =============================================================================
# TEST 1: Basic G-test returns valid result structure
# =============================================================================

query I
SELECT (g_test_agg(row_var, col_var)).statistic IS NOT NULL FROM g_test_data;
----
true

query I
SELECT (g_test_agg(row_var, col_var)).p_value IS NOT NULL FROM g_test_data;
----
true

query I
SELECT (g_test_agg(row_var, col_var)).df IS NOT NULL FROM g_test_data;
----
true

query I
SELECT (g_test_agg(row_var, col_var)).method IS NOT NULL FROM g_test_data;
----
true

# =============================================================================
# TEST 2: Degrees of freedom = (rows-1) * (cols-1) = 1
# =============================================================================

query I
SELECT (g_test_agg(row_var, col_var)).df = 1 FROM g_test_data;
----
true

# =============================================================================
# TEST 3: No significant association (balanced table)
# =============================================================================

statement ok
CREATE TABLE no_assoc AS
SELECT * FROM (VALUES
    (0, 0), (0, 0), (0, 0), (0, 0), (0, 0), (0, 0), (0, 0), (0, 0), (0, 0), (0, 0),
    (0, 1), (0, 1), (0, 1), (0, 1), (0, 1), (0, 1), (0, 1), (0, 1), (0, 1), (0, 1),
    (1, 0), (1, 0), (1, 0), (1, 0), (1, 0), (1, 0), (1, 0), (1, 0), (1, 0), (1, 0),
    (1, 1), (1, 1), (1, 1), (1, 1), (1, 1), (1, 1), (1, 1), (1, 1), (1, 1), (1, 1)
) AS t(row_var, col_var);

query I
SELECT (g_test_agg(row_var, col_var)).p_value > 0.5 FROM no_assoc;
----
true

# =============================================================================
# TEST 4: Strong association (significant)
# =============================================================================

statement ok
CREATE TABLE strong_assoc AS
SELECT * FROM (VALUES
    (0, 0), (0, 0), (0, 0), (0, 0), (0, 0), (0, 0), (0, 0), (0, 0), (0, 0), (0, 0),
    (0, 0), (0, 0), (0, 0), (0, 0), (0, 0), (0, 0), (0, 0), (0, 0), (0, 0), (0, 0),
    (0, 1),
    (1, 0),
    (1, 1), (1, 1), (1, 1), (1, 1), (1, 1), (1, 1), (1, 1), (1, 1), (1, 1), (1, 1),
    (1, 1), (1, 1), (1, 1), (1, 1), (1, 1), (1, 1), (1, 1), (1, 1), (1, 1), (1, 1)
) AS t(row_var, col_var);

query I
SELECT (g_test_agg(row_var, col_var)).p_value < 0.001 FROM strong_assoc;
----
true

# =============================================================================
# TEST 5: 3x3 contingency table
# =============================================================================

statement ok
CREATE TABLE contingency_3x3 AS
SELECT * FROM (VALUES
    (0, 0), (0, 0), (0, 0), (0, 0), (0, 0),
    (0, 1), (0, 1), (0, 1), (0, 1), (0, 1), (0, 1), (0, 1), (0, 1), (0, 1), (0, 1),
    (0, 2), (0, 2), (0, 2), (0, 2), (0, 2), (0, 2), (0, 2), (0, 2), (0, 2), (0, 2),
    (0, 2), (0, 2), (0, 2), (0, 2), (0, 2),
    (1, 0), (1, 0), (1, 0), (1, 0), (1, 0), (1, 0), (1, 0), (1, 0),
    (1, 1), (1, 1), (1, 1), (1, 1), (1, 1), (1, 1), (1, 1), (1, 1), (1, 1), (1, 1),
    (1, 2), (1, 2), (1, 2), (1, 2), (1, 2), (1, 2), (1, 2), (1, 2), (1, 2), (1, 2),
    (1, 2), (1, 2),
    (2, 0), (2, 0), (2, 0), (2, 0), (2, 0), (2, 0), (2, 0), (2, 0), (2, 0), (2, 0),
    (2, 1), (2, 1), (2, 1), (2, 1), (2, 1), (2, 1), (2, 1), (2, 1), (2, 1), (2, 1),
    (2, 1), (2, 1), (2, 1), (2, 1), (2, 1),
    (2, 2), (2, 2), (2, 2), (2, 2), (2, 2), (2, 2), (2, 2), (2, 2), (2, 2), (2, 2),
    (2, 2), (2, 2), (2, 2), (2, 2), (2, 2), (2, 2), (2, 2), (2, 2), (2, 2), (2, 2)
) AS t(row_var, col_var);

# df = (3-1) * (3-1) = 4
query I
SELECT (g_test_agg(row_var, col_var)).df = 4 FROM contingency_3x3;
----
true

# =============================================================================
# TEST 6: GROUP BY partitioning
# =============================================================================

statement ok
CREATE TABLE grouped_data AS
SELECT * FROM (VALUES
    ('A', 0, 0), ('A', 0, 0), ('A', 0, 0), ('A', 0, 0), ('A', 0, 0),
    ('A', 0, 0), ('A', 0, 0), ('A', 0, 0), ('A', 0, 0), ('A', 0, 0),
    ('A', 0, 1), ('A', 0, 1),
    ('A', 1, 0), ('A', 1, 0),
    ('A', 1, 1), ('A', 1, 1), ('A', 1, 1), ('A', 1, 1), ('A', 1, 1),
    ('A', 1, 1), ('A', 1, 1), ('A', 1, 1), ('A', 1, 1), ('A', 1, 1),
    ('B', 0, 0), ('B', 0, 0), ('B', 0, 0), ('B', 0, 0), ('B', 0, 0),
    ('B', 0, 1), ('B', 0, 1), ('B', 0, 1), ('B', 0, 1), ('B', 0, 1),
    ('B', 1, 0), ('B', 1, 0), ('B', 1, 0), ('B', 1, 0), ('B', 1, 0),
    ('B', 1, 1), ('B', 1, 1), ('B', 1, 1), ('B', 1, 1), ('B', 1, 1)
) AS t(category, row_var, col_var);

query TI
SELECT category, (g_test_agg(row_var, col_var)).p_value < 0.05 AS significant
FROM grouped_data
GROUP BY category
ORDER BY category;
----
A	true
B	false

# =============================================================================
# TEST 7: Alias verification (anofox_stats_g_test_agg)
# =============================================================================

query I
SELECT (anofox_stats_g_test_agg(row_var, col_var)).statistic IS NOT NULL FROM g_test_data;
----
true

# =============================================================================
# CLEANUP
# =============================================================================

statement ok
DROP TABLE IF EXISTS g_test_data;

statement ok
DROP TABLE IF EXISTS no_assoc;

statement ok
DROP TABLE IF EXISTS strong_assoc;

statement ok
DROP TABLE IF EXISTS contingency_3x3;

statement ok
DROP TABLE IF EXISTS grouped_data;
