# name: test/sql/full_output.test
# description: Test full_output option for all regression functions
# group: [sql]

require anofox_statistics

# Test 1: OLS with full_output=true returns extended columns
# Verify all 13 columns are present (8 basic + 5 extended)
query TTTTTTTTTTTTT
SELECT
    intercept IS NOT NULL as has_intercept,
    coefficients IS NOT NULL as has_coefficients,
    r_squared IS NOT NULL as has_r_squared,
    adj_r_squared IS NOT NULL as has_adj_r_squared,
    mse IS NOT NULL as has_mse,
    rmse IS NOT NULL as has_rmse,
    n_obs IS NOT NULL as has_n_obs,
    n_features IS NOT NULL as has_n_features,
    coefficient_std_errors IS NOT NULL as has_coef_se,
    intercept_std_error IS NOT NULL as has_intercept_se,
    df_residual IS NOT NULL as has_df_residual,
    is_aliased IS NOT NULL as has_is_aliased,
    x_train_means IS NOT NULL as has_x_train_means
FROM anofox_statistics_ols(
    [2.1, 4.2, 5.9, 8.1, 10.0]::DOUBLE[],
    [[1.0], [2.0], [3.0], [4.0], [5.0]]::DOUBLE[][],
    {'intercept': true, 'full_output': true}
);
----
true	true	true	true	true	true	true	true	true	true	true	true	true

# Test 2: OLS with full_output=false returns only basic columns (8)
# This should NOT have the extended columns
query TTTTTTTT
SELECT
    intercept IS NOT NULL as has_intercept,
    coefficients IS NOT NULL as has_coefficients,
    r_squared IS NOT NULL as has_r_squared,
    adj_r_squared IS NOT NULL as has_adj_r_squared,
    mse IS NOT NULL as has_mse,
    rmse IS NOT NULL as has_rmse,
    n_obs IS NOT NULL as has_n_obs,
    n_features IS NOT NULL as has_n_features
FROM anofox_statistics_ols(
    [2.1, 4.2, 5.9, 8.1, 10.0]::DOUBLE[],
    [[1.0], [2.0], [3.0], [4.0], [5.0]]::DOUBLE[][],
    {'intercept': true, 'full_output': false}
);
----
true	true	true	true	true	true	true	true

# Test 3: OLS full_output - verify df_residual is correct
# n=5, p=1, intercept=true → df_residual = n - p - 1 = 5 - 1 - 1 = 3
query I
SELECT df_residual::BIGINT as df_residual
FROM anofox_statistics_ols(
    [2.1, 4.2, 5.9, 8.1, 10.0]::DOUBLE[],
    [[1.0], [2.0], [3.0], [4.0], [5.0]]::DOUBLE[][],
    {'intercept': true, 'full_output': true}
);
----
3

# Test 4: OLS full_output - verify intercept standard error is positive
# Note: coefficient_std_errors currently returns NULL for single feature case
query T
SELECT
    intercept_std_error::DOUBLE > 0 as intercept_se_positive
FROM anofox_statistics_ols(
    [2.1, 4.2, 5.9, 8.1, 10.0]::DOUBLE[],
    [[1.0], [2.0], [3.0], [4.0], [5.0]]::DOUBLE[][],
    {'intercept': true, 'full_output': true}
);
----
true

# Test 5: OLS full_output - verify x_train_means are computed correctly
# x_train_means should equal mean of input x = (1+2+3+4+5)/5 = 3.0
query R
SELECT round(x_train_means[1]::DOUBLE, 10) as x_mean
FROM anofox_statistics_ols(
    [2.1, 4.2, 5.9, 8.1, 10.0]::DOUBLE[],
    [[1.0], [2.0], [3.0], [4.0], [5.0]]::DOUBLE[][],
    {'intercept': true, 'full_output': true}
);
----
3.0

# Test 6: OLS full_output - verify is_aliased array length matches n_features
query T
SELECT array_length(is_aliased) = n_features::BIGINT as aliased_array_correct_length
FROM anofox_statistics_ols(
    [2.1, 4.2, 5.9, 8.1, 10.0]::DOUBLE[],
    [[1.0, 10.0], [2.0, 11.0], [3.0, 12.0], [4.0, 13.0], [5.0, 14.0]]::DOUBLE[][],
    {'intercept': true, 'full_output': true}
);
----
true

# Test 7: OLS full_output - aliased coefficients have NULL std errors
# Create rank-deficient case with constant feature
query TT
SELECT
    coefficients[2] IS NULL as coef2_is_null,
    coefficient_std_errors[2] IS NULL as coef2_se_is_null
FROM anofox_statistics_ols(
    [2.0, 4.0, 6.0, 8.0, 10.0]::DOUBLE[],
    [[1.0, 5.0], [2.0, 5.0], [3.0, 5.0], [4.0, 5.0], [5.0, 5.0]]::DOUBLE[][],
    {'intercept': true, 'full_output': true}
);
----
true	true

# Test 8: Ridge with full_output=true returns extended columns
query TTTTTTTTTTTT
SELECT
    intercept IS NOT NULL as has_intercept,
    coefficients IS NOT NULL as has_coefficients,
    r_squared IS NOT NULL as has_r_squared,
    adj_r_squared IS NOT NULL as has_adj_r_squared,
    mse IS NOT NULL as has_mse,
    rmse IS NOT NULL as has_rmse,
    n_obs IS NOT NULL as has_n_obs,
    n_features IS NOT NULL as has_n_features,
    coefficient_std_errors IS NOT NULL as has_coef_se,
    intercept_std_error IS NOT NULL as has_intercept_se,
    df_residual IS NOT NULL as has_df_residual,
    x_train_means IS NOT NULL as has_x_train_means
FROM anofox_statistics_ridge(
    [2.1, 4.2, 5.9, 8.1, 10.0]::DOUBLE[],
    [[1.0], [2.0], [3.0], [4.0], [5.0]]::DOUBLE[][],
    {'intercept': true, 'lambda': 0.1, 'full_output': true}
);
----
true	true	true	true	true	true	true	true	true	true	true	true

# Test 9: Ridge with lambda=0 and full_output should match OLS results closely
query T
SELECT
    intercept_std_error::DOUBLE > 0 AND
    coefficient_std_errors[1]::DOUBLE > 0 as std_errors_positive
FROM anofox_statistics_ridge(
    [2.1, 4.2, 5.9, 8.1, 10.0]::DOUBLE[],
    [[1.0], [2.0], [3.0], [4.0], [5.0]]::DOUBLE[][],
    {'intercept': true, 'lambda': 0.0, 'full_output': true}
);
----
true

# Test 10: WLS with full_output=true returns extended columns
query TTTTTTTTTTTT
SELECT
    intercept IS NOT NULL as has_intercept,
    coefficients IS NOT NULL as has_coefficients,
    r_squared IS NOT NULL as has_r_squared,
    adj_r_squared IS NOT NULL as has_adj_r_squared,
    mse IS NOT NULL as has_mse,
    rmse IS NOT NULL as has_rmse,
    n_obs IS NOT NULL as has_n_obs,
    n_features IS NOT NULL as has_n_features,
    coefficient_std_errors IS NOT NULL as has_coef_se,
    intercept_std_error IS NOT NULL as has_intercept_se,
    df_residual IS NOT NULL as has_df_residual,
    x_train_means IS NOT NULL as has_x_train_means
FROM anofox_statistics_wls(
    [2.1, 4.2, 5.9, 8.1, 10.0]::DOUBLE[],
    [[1.0], [2.0], [3.0], [4.0], [5.0]]::DOUBLE[][],
    [1.0, 1.0, 1.0, 1.0, 1.0]::DOUBLE[],
    {'intercept': true, 'full_output': true}
);
----
true	true	true	true	true	true	true	true	true	true	true	true

# Test 11: Elastic Net with full_output=true returns extended columns
# Note: Elastic Net has 11 basic columns + 5 extended = 16 total
query TTTTTTTTTTTTTTTT
SELECT
    intercept IS NOT NULL as has_intercept,
    coefficients IS NOT NULL as has_coefficients,
    r_squared IS NOT NULL as has_r_squared,
    adj_r_squared IS NOT NULL as has_adj_r_squared,
    mse IS NOT NULL as has_mse,
    rmse IS NOT NULL as has_rmse,
    n_obs IS NOT NULL as has_n_obs,
    n_features IS NOT NULL as has_n_features,
    alpha IS NOT NULL as has_alpha,
    reg_lambda IS NOT NULL as has_lambda,
    n_nonzero IS NOT NULL as has_n_nonzero,
    coefficient_std_errors IS NOT NULL as has_coef_se,
    intercept_std_error IS NOT NULL as has_intercept_se,
    df_residual IS NOT NULL as has_df_residual,
    is_zero IS NOT NULL as has_is_zero,
    x_train_means IS NOT NULL as has_x_train_means
FROM anofox_statistics_elastic_net(
    [2.1, 4.2, 5.9, 8.1, 10.0]::DOUBLE[],
    [[1.0], [2.0], [3.0], [4.0], [5.0]]::DOUBLE[][],
    {'intercept': true, 'alpha': 0.5, 'lambda': 0.01, 'full_output': true}
);
----
true	true	true	true	true	true	true	true	true	true	true	true	true	true	true	true

# Test 12: Elastic Net full_output - verify is_zero tracks zeroed coefficients
# High lambda should cause some coefficients to be exactly zero
query T
SELECT
    array_length(is_zero) = n_features::BIGINT as is_zero_array_correct_length
FROM anofox_statistics_elastic_net(
    [2.1, 4.2, 5.9, 8.1, 10.0]::DOUBLE[],
    [[1.0, 5.0], [2.0, 6.0], [3.0, 7.0], [4.0, 8.0], [5.0, 9.0]]::DOUBLE[][],
    {'intercept': true, 'alpha': 1.0, 'lambda': 10.0, 'full_output': true}
);
----
true

# Test 13: RLS with full_output=true returns extended columns
query TTTTTTTTTTTT
SELECT
    intercept IS NOT NULL as has_intercept,
    coefficients IS NOT NULL as has_coefficients,
    r_squared IS NOT NULL as has_r_squared,
    adj_r_squared IS NOT NULL as has_adj_r_squared,
    mse IS NOT NULL as has_mse,
    rmse IS NOT NULL as has_rmse,
    n_obs IS NOT NULL as has_n_obs,
    n_features IS NOT NULL as has_n_features,
    coefficient_std_errors IS NOT NULL as has_coef_se,
    intercept_std_error IS NOT NULL as has_intercept_se,
    df_residual IS NOT NULL as has_df_residual,
    x_train_means IS NOT NULL as has_x_train_means
FROM anofox_statistics_rls(
    [2.1, 4.2, 5.9, 8.1, 10.0]::DOUBLE[],
    [[1.0], [2.0], [3.0], [4.0], [5.0]]::DOUBLE[][],
    {'intercept': true, 'lambda': 0.99, 'full_output': true}
);
----
true	true	true	true	true	true	true	true	true	true	true	true

# Test 14: Multiple regression - verify coefficient_std_errors array length
query T
SELECT
    array_length(coefficient_std_errors) = n_features::BIGINT as se_array_correct_length
FROM anofox_statistics_ols(
    [9.3, 23.0, 20.1, 27.5, 23.3, 40.4, 36.6, 43.2, 44.8, 59.3]::DOUBLE[],
    [[1.0, 5.2, 2.3], [2.0, 2.8, 8.1], [3.0, 7.1, 3.7], [4.0, 1.5, 6.9], [5.0, 9.3, 1.4], [6.0, 3.6, 9.6], [7.0, 8.4, 4.5], [8.0, 4.2, 7.2], [9.0, 6.7, 5.8], [10.0, 10.1, 10.3]]::DOUBLE[][],
    {'intercept': true, 'full_output': true}
);
----
true

# Test 15: Verify x_train_means array length matches n_features
query T
SELECT
    array_length(x_train_means) = n_features::BIGINT as means_array_correct_length
FROM anofox_statistics_ridge(
    [9.3, 23.0, 20.1, 27.5, 23.3, 40.4, 36.6, 43.2, 44.8, 59.3]::DOUBLE[],
    [[1.0, 5.2, 2.3], [2.0, 2.8, 8.1], [3.0, 7.1, 3.7], [4.0, 1.5, 6.9], [5.0, 9.3, 1.4], [6.0, 3.6, 9.6], [7.0, 8.4, 4.5], [8.0, 4.2, 7.2], [9.0, 6.7, 5.8], [10.0, 10.1, 10.3]]::DOUBLE[][],
    {'intercept': true, 'lambda': 0.5, 'full_output': true}
);
----
true

# Test 16: OLS without intercept - verify df_residual is correct
# n=5, p=1, intercept=false → df_residual = n - p = 5 - 1 = 4
query I
SELECT df_residual::BIGINT as df_residual
FROM anofox_statistics_ols(
    [2.0, 4.0, 6.0, 8.0, 10.0]::DOUBLE[],
    [[1.0], [2.0], [3.0], [4.0], [5.0]]::DOUBLE[][],
    {'intercept': false, 'full_output': true}
);
----
4
