# name: test/sql/fit_predict/test_ridge_fit_predict_edge.test
# description: Test edge cases for Ridge fit-predict
# group: [fit_predict]

require anofox_statistics

# Test 1: Insufficient training data (less than p+1 observations for intercept model)
# With intercept and 2 features, we need at least 4 training rows (3 params + 1 for variance)
statement ok
CREATE TABLE ridge_insufficient AS
SELECT
    i as id,
    i::DOUBLE as x1,
    (i * 0.5)::DOUBLE as x2,
    CASE WHEN i <= 2 THEN (i * 2.0)::DOUBLE ELSE NULL END as y  -- Only 2 training rows for 3 params
FROM range(1, 6) t(i);

# With limited training data, predictions may be NULL
query I
SELECT
    COUNT(*) as all_rows
FROM (
    SELECT
        id,
        anofox_stats_ridge_fit_predict(
            y,
            [x1, x2],
            {'intercept': 1.0, 'alpha': 1.0}
        ) OVER (ORDER BY id) as pred
    FROM ridge_insufficient
);
----
5

# Test 2: All NULL y values
statement ok
CREATE TABLE ridge_all_null AS
SELECT
    i as id,
    i::DOUBLE as x,
    NULL::DOUBLE as y
FROM range(1, 8) t(i);

# All NULL training data should produce NULL predictions
query I
SELECT
    COUNT(*) as null_predictions
FROM (
    SELECT
        id,
        anofox_stats_ridge_fit_predict(
            y,
            [x],
            {'intercept': 1.0, 'alpha': 1.0}
        ) OVER (ORDER BY id) as pred
    FROM ridge_all_null
)
WHERE (pred).yhat IS NULL;
----
7

# Test 3: Empty feature array
statement ok
CREATE TABLE ridge_empty_features AS
SELECT
    i as id,
    CASE WHEN i <= 4 THEN (i * 2.0)::DOUBLE ELSE NULL END as y,
    []::DOUBLE[] as x_empty
FROM range(1, 7) t(i);

# Empty features should produce NULL predictions
query I
SELECT
    COUNT(*) as null_predictions
FROM (
    SELECT
        id,
        anofox_stats_ridge_fit_predict(
            y,
            x_empty,
            {'intercept': 1.0, 'alpha': 1.0}
        ) OVER (ORDER BY id) as pred
    FROM ridge_empty_features
)
WHERE (pred).yhat IS NULL;
----
6

# Test 4: Single training observation (edge case)
statement ok
CREATE TABLE ridge_single_train AS
SELECT
    i as id,
    i::DOUBLE as x,
    CASE WHEN i = 1 THEN 5.0 ELSE NULL END as y
FROM range(1, 6) t(i);

# Single training point - needs at least 2 for intercept model, so all are NULL
query I
SELECT
    COUNT(*) as null_predictions
FROM (
    SELECT
        id,
        anofox_stats_ridge_fit_predict(
            y,
            [x],
            {'intercept': 1.0, 'alpha': 1.0}
        ) OVER (ORDER BY id) as pred
    FROM ridge_single_train
)
WHERE (pred).yhat IS NULL;
----
5

# Test 5: Zero alpha (no regularization, equivalent to OLS)
statement ok
CREATE TABLE ridge_params AS
SELECT
    i as id,
    i::DOUBLE as x,
    CASE WHEN i <= 5 THEN (i * 2.0)::DOUBLE ELSE NULL END as y
FROM range(1, 9) t(i);

query I
SELECT
    COUNT(*) as predictions
FROM (
    SELECT
        id,
        anofox_stats_ridge_fit_predict(
            y,
            [x],
            {'intercept': 1.0, 'alpha': 0.0}
        ) OVER (ORDER BY id) as pred
    FROM ridge_params
)
WHERE (pred).yhat IS NOT NULL;
----
6

# Test 6: Very large lambda (extreme shrinkage towards zero)
query I
SELECT
    COUNT(*) as predictions
FROM (
    SELECT
        id,
        anofox_stats_ridge_fit_predict(
            y,
            [x],
            {'intercept': 1.0, 'alpha': 10000.0}
        ) OVER (ORDER BY id) as pred
    FROM ridge_params
)
WHERE (pred).yhat IS NOT NULL AND NOT ISINF((pred).yhat) AND NOT ISNAN((pred).yhat);
----
6

# Test 7: PARTITION BY with different amounts of training data per partition
statement ok
CREATE TABLE ridge_partial_partitions AS
SELECT
    i as id,
    group_id,
    i::DOUBLE as x,
    CASE
        WHEN group_id = 'A' AND i <= 5 THEN (i * 2.0)::DOUBLE
        WHEN group_id = 'B' AND i <= 1 THEN (i * 3.0)::DOUBLE  -- Only 1 training row (insufficient)
        ELSE NULL
    END as y
FROM range(1, 8) t(i),
     (VALUES ('A'), ('B')) g(group_id);

# Group A has 5 training rows (sufficient), Group B has 1 (insufficient for intercept model)
query I
SELECT
    COUNT(*) as predictions
FROM (
    SELECT
        group_id,
        id,
        anofox_stats_ridge_fit_predict(
            y,
            [x],
            {'intercept': 1.0, 'alpha': 1.0}
        ) OVER (PARTITION BY group_id ORDER BY id) as pred
    FROM ridge_partial_partitions
)
WHERE (pred).yhat IS NOT NULL;
----
5

# Test 8: Extreme x values (numerical stability)
statement ok
CREATE TABLE ridge_extreme_values AS
SELECT
    i as id,
    (i * 1000000.0)::DOUBLE as x_large,
    CASE WHEN i <= 5 THEN (i * 2.0)::DOUBLE ELSE NULL END as y
FROM range(1, 9) t(i);

query I
SELECT
    COUNT(*) as predictions
FROM (
    SELECT
        id,
        anofox_stats_ridge_fit_predict(
            y,
            [x_large],
            {'intercept': 1.0, 'alpha': 1.0}
        ) OVER (ORDER BY id) as pred
    FROM ridge_extreme_values
)
WHERE (pred).yhat IS NOT NULL AND NOT ISINF((pred).yhat) AND NOT ISNAN((pred).yhat);
----
6

# Cleanup
statement ok
DROP TABLE ridge_insufficient;

statement ok
DROP TABLE ridge_all_null;

statement ok
DROP TABLE ridge_empty_features;

statement ok
DROP TABLE ridge_single_train;

statement ok
DROP TABLE ridge_params;

statement ok
DROP TABLE ridge_partial_partitions;

statement ok
DROP TABLE ridge_extreme_values;
