# name: test/sql/fit_predict/test_elastic_net_fit_predict_edge.test
# description: Test edge cases for Elastic Net fit-predict
# group: [fit_predict]

require anofox_statistics

# Test 1: Insufficient training data
statement ok
CREATE TABLE elastic_net_insufficient AS
SELECT
    i as id,
    i::DOUBLE as x1,
    (i * 0.5)::DOUBLE as x2,
    CASE WHEN i <= 2 THEN (i * 2.0)::DOUBLE ELSE NULL END as y
FROM range(1, 6) t(i);

query I
SELECT
    COUNT(*) as null_predictions
FROM (
    SELECT
        id,
        anofox_statistics_fit_predict_elastic_net(
            y,
            [x1, x2],
            MAP{'intercept': 1, 'alpha': 0.5, 'lambda': 1.0}
        ) OVER (ORDER BY id ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) as pred
    FROM elastic_net_insufficient
)
WHERE (pred).yhat IS NULL;
----
0

# Test 2: All NULL y values
statement ok
CREATE TABLE elastic_net_all_null AS
SELECT
    i as id,
    i::DOUBLE as x,
    NULL::DOUBLE as y
FROM range(1, 8) t(i);

query I
SELECT
    COUNT(*) as null_predictions
FROM (
    SELECT
        id,
        anofox_statistics_fit_predict_elastic_net(
            y,
            [x],
            MAP{'intercept': 1, 'alpha': 0.5, 'lambda': 1.0}
        ) OVER (ORDER BY id ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) as pred
    FROM elastic_net_all_null
)
WHERE (pred).yhat IS NULL;
----
0

# Test 3: Empty feature array
statement ok
CREATE TABLE elastic_net_empty AS
SELECT
    i as id,
    CASE WHEN i <= 4 THEN (i * 2.0)::DOUBLE ELSE NULL END as y,
    []::DOUBLE[] as x_empty
FROM range(1, 7) t(i);

query I
SELECT
    COUNT(*) as null_predictions
FROM (
    SELECT
        id,
        anofox_statistics_fit_predict_elastic_net(
            y,
            x_empty,
            MAP{'intercept': 1, 'alpha': 0.5, 'lambda': 1.0}
        ) OVER (ORDER BY id ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) as pred
    FROM elastic_net_empty
)
WHERE (pred).yhat IS NULL;
----
6

# Test 4: Invalid alpha (outside [0, 1])
statement ok
CREATE TABLE elastic_net_params AS
SELECT
    i as id,
    i::DOUBLE as x,
    CASE WHEN i <= 5 THEN (i * 2.0)::DOUBLE ELSE NULL END as y
FROM range(1, 9) t(i);

query I
SELECT
    COUNT(*) as predictions_alpha_zero
FROM (
    SELECT
        id,
        anofox_statistics_fit_predict_elastic_net(
            y,
            [x],
            MAP{'intercept': 1, 'alpha': 0.0, 'lambda': 1.0}
        ) OVER (ORDER BY id ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) as pred
    FROM elastic_net_params
)
WHERE (pred).yhat IS NOT NULL;
----
9

# Test 5: Alpha = 1.0 (pure Lasso)
query I
SELECT
    COUNT(*) as predictions_alpha_one
FROM (
    SELECT
        id,
        anofox_statistics_fit_predict_elastic_net(
            y,
            [x],
            MAP{'intercept': 1, 'alpha': 1.0, 'lambda': 1.0}
        ) OVER (ORDER BY id ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) as pred
    FROM elastic_net_params
)
WHERE (pred).yhat IS NOT NULL;
----
9

# Test 6: Very large lambda (extreme shrinkage)
query I
SELECT
    COUNT(*) as predictions_near_zero
FROM (
    SELECT
        id,
        (pred).yhat as yhat
    FROM (
        SELECT
            id,
            anofox_statistics_fit_predict_elastic_net(
                y,
                [x],
                MAP{'intercept': 1, 'alpha': 0.5, 'lambda': 100000.0}
            ) OVER (ORDER BY id ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) as pred
        FROM elastic_net_params
    )
)
WHERE yhat IS NOT NULL AND ABS(yhat) < 10;
----
9

# Test 7: NULL values in feature arrays
statement ok
CREATE TABLE elastic_net_null_features AS
SELECT
    i as id,
    CASE WHEN i <= 5 THEN (i * 2.0)::DOUBLE ELSE NULL END as y,
    CASE WHEN i % 2 = 0 THEN [i::DOUBLE, NULL] ELSE [i::DOUBLE, (i * 0.5)::DOUBLE] END as x
FROM range(1, 9) t(i);

query I
SELECT
    COUNT(*) as has_predictions
FROM (
    SELECT
        id,
        anofox_statistics_fit_predict_elastic_net(
            y,
            x,
            MAP{'intercept': 1, 'alpha': 0.5, 'lambda': 1.0}
        ) OVER (ORDER BY id ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) as pred
    FROM elastic_net_null_features
)
WHERE (pred).yhat IS NOT NULL;
----
4

# Test 8: Single training observation
statement ok
CREATE TABLE elastic_net_single AS
SELECT
    i as id,
    i::DOUBLE as x,
    CASE WHEN i = 1 THEN 5.0 ELSE NULL END as y
FROM range(1, 6) t(i);

query I
SELECT
    COUNT(*) as null_predictions
FROM (
    SELECT
        id,
        anofox_statistics_fit_predict_elastic_net(
            y,
            [x],
            MAP{'intercept': 1, 'alpha': 0.5, 'lambda': 1.0}
        ) OVER (ORDER BY id ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) as pred
    FROM elastic_net_single
)
WHERE (pred).yhat IS NULL;
----
6

# Test 9: PARTITION BY with insufficient data in some partitions
statement ok
CREATE TABLE elastic_net_partitions AS
SELECT
    i as id,
    group_id,
    i::DOUBLE as x,
    CASE
        WHEN group_id = 'A' AND i <= 5 THEN (i * 2.0)::DOUBLE
        WHEN group_id = 'B' AND i <= 1 THEN (i * 3.0)::DOUBLE
        ELSE NULL
    END as y
FROM range(1, 8) t(i),
     (VALUES ('A'), ('B')) g(group_id);

query II
SELECT
    group_id,
    COUNT(*) as predictions
FROM (
    SELECT
        group_id,
        id,
        anofox_statistics_fit_predict_elastic_net(
            y,
            [x],
            MAP{'intercept': 1, 'alpha': 0.5, 'lambda': 1.0}
        ) OVER (PARTITION BY group_id) as pred
    FROM elastic_net_partitions
)
WHERE (pred).yhat IS NOT NULL
GROUP BY group_id
ORDER BY group_id;
----
A	7

# Test 10: Extreme feature values (numerical stability)
statement ok
CREATE TABLE elastic_net_extreme AS
SELECT
    i as id,
    (i * 1000000.0)::DOUBLE as x_large,
    CASE WHEN i <= 5 THEN (i * 2.0)::DOUBLE ELSE NULL END as y
FROM range(1, 9) t(i);

query I
SELECT
    COUNT(*) as predictions
FROM (
    SELECT
        id,
        anofox_statistics_fit_predict_elastic_net(
            y,
            [x_large],
            MAP{'intercept': 1, 'alpha': 0.5, 'lambda': 1.0}
        ) OVER (ORDER BY id ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) as pred
    FROM elastic_net_extreme
)
WHERE (pred).yhat IS NOT NULL AND NOT ISINF((pred).yhat) AND NOT ISNAN((pred).yhat);
----
9

# Cleanup
statement ok
DROP TABLE elastic_net_insufficient;

statement ok
DROP TABLE elastic_net_all_null;

statement ok
DROP TABLE elastic_net_empty;

statement ok
DROP TABLE elastic_net_params;

statement ok
DROP TABLE elastic_net_null_features;

statement ok
DROP TABLE elastic_net_single;

statement ok
DROP TABLE elastic_net_partitions;

statement ok
DROP TABLE elastic_net_extreme;
