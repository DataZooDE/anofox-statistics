# name: test/sql/fit_predict/test_ridge_fit_predict_validation.test
# description: Numerical validation tests for Ridge fit-predict
# group: [fit_predict]

require anofox_statistics

# Test 1: Prediction intervals should contain predictions
statement ok
CREATE TABLE ridge_val AS
SELECT
    i as id,
    i::DOUBLE as x,
    CASE WHEN i <= 10 THEN (i * 2.0)::DOUBLE ELSE NULL END as y
FROM range(1, 16) t(i);

# First 2 rows are NULL (not enough training data for intercept model)
query I
SELECT
    COUNT(*) as valid_intervals
FROM (
    SELECT
        id,
        (pred).yhat as yhat,
        (pred).yhat_lower as lower,
        (pred).yhat_upper as upper
    FROM (
        SELECT
            id,
            anofox_stats_ridge_fit_predict(
                y, [x], {'intercept': 1.0, 'alpha': 1.0}
            ) OVER (ORDER BY id ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) as pred
        FROM ridge_val
    )
)
WHERE yhat IS NOT NULL AND lower <= yhat AND yhat <= upper;
----
13

# Test 2: Prediction intervals should have positive width (where predictions exist)
query I
SELECT
    COUNT(*) as positive_width_intervals
FROM (
    SELECT
        (pred).yhat as yhat,
        (pred).yhat_upper - (pred).yhat_lower as width
    FROM (
        SELECT
            anofox_stats_ridge_fit_predict(
                y, [x], {'intercept': 1.0, 'alpha': 1.0}
            ) OVER (ORDER BY id ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) as pred
        FROM ridge_val
    )
)
WHERE yhat IS NOT NULL AND width > 0;
----
13

# Test 3: Predictions should be finite (where not NULL)
query I
SELECT
    COUNT(*) as finite_predictions
FROM (
    SELECT
        (pred).yhat as yhat
    FROM (
        SELECT
            anofox_stats_ridge_fit_predict(
                y, [x], {'intercept': 1.0, 'alpha': 1.0}
            ) OVER (ORDER BY id ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) as pred
        FROM ridge_val
    )
)
WHERE yhat IS NOT NULL AND NOT ISINF(yhat) AND NOT ISNAN(yhat);
----
13

# Test 4: Higher alpha should produce different (more shrunk) predictions
statement ok
CREATE TABLE ridge_alpha_val AS
SELECT
    i as id,
    i::DOUBLE as x,
    CASE WHEN i <= 8 THEN (i * 3.0 + 5.0)::DOUBLE ELSE NULL END as y
FROM range(1, 13) t(i);

# Different alpha values should produce at least some different predictions
query I
SELECT
    COUNT(*) as predictions_differ
FROM (
    SELECT
        id,
        ABS((pred_low).yhat - (pred_high).yhat) as diff
    FROM (
        SELECT
            id,
            anofox_stats_ridge_fit_predict(y, [x], {'intercept': 1.0, 'alpha': 0.1}) OVER (ORDER BY id ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) as pred_low,
            anofox_stats_ridge_fit_predict(y, [x], {'intercept': 1.0, 'alpha': 10.0}) OVER (ORDER BY id ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) as pred_high
        FROM ridge_alpha_val
    )
)
WHERE diff > 0.01;
----
10

# Test 5: Predictions should be monotonic for monotonic inputs (for non-NULL predictions)
query I
SELECT
    COUNT(*) as monotonic_pairs
FROM (
    SELECT
        id,
        (pred).yhat as yhat,
        LAG((pred).yhat) OVER (ORDER BY id) as prev_yhat
    FROM (
        SELECT
            id,
            anofox_stats_ridge_fit_predict(
                y, [x], {'intercept': 1.0, 'alpha': 1.0}
            ) OVER (ORDER BY id ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) as pred
        FROM ridge_val
    )
)
WHERE yhat IS NOT NULL AND prev_yhat IS NOT NULL AND yhat > prev_yhat;
----
12

statement ok
DROP TABLE ridge_val;

statement ok
DROP TABLE ridge_alpha_val;
