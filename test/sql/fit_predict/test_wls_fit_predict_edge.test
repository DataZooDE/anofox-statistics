# name: test/sql/fit_predict/test_wls_fit_predict_edge.test
# description: Test edge cases for WLS fit-predict
# group: [fit_predict]

require anofox_statistics

# Test 1: Insufficient training data
statement ok
CREATE TABLE wls_insufficient AS
SELECT
    i as id,
    i::DOUBLE as x1,
    (i * 0.5)::DOUBLE as x2,
    CASE WHEN i <= 2 THEN (i * 2.0)::DOUBLE ELSE NULL END as y,
    1.0::DOUBLE as w
FROM range(1, 6) t(i);

query I
SELECT
    COUNT(*) as null_predictions
FROM (
    SELECT
        id,
        anofox_statistics_fit_predict_wls(
            y,
            [x1, x2],
            w,
            MAP{'intercept': 1}
        ) OVER (ORDER BY id ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) as pred
    FROM wls_insufficient
)
WHERE (pred).yhat IS NULL;
----
5

# Test 2: All NULL y values
statement ok
CREATE TABLE wls_all_null AS
SELECT
    i as id,
    i::DOUBLE as x,
    NULL::DOUBLE as y,
    1.0::DOUBLE as w
FROM range(1, 8) t(i);

query I
SELECT
    COUNT(*) as null_predictions
FROM (
    SELECT
        id,
        anofox_statistics_fit_predict_wls(
            y,
            [x],
            w,
            MAP{'intercept': 1}
        ) OVER (ORDER BY id ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) as pred
    FROM wls_all_null
)
WHERE (pred).yhat IS NULL;
----
7

# Test 3: Negative weights (invalid - should return NULL)
statement ok
CREATE TABLE wls_negative_weights AS
SELECT
    i as id,
    i::DOUBLE as x,
    CASE WHEN i <= 5 THEN (i * 2.0)::DOUBLE ELSE NULL END as y,
    CASE WHEN i = 3 THEN -1.0 ELSE 1.0 END::DOUBLE as w
FROM range(1, 9) t(i);

query I
SELECT
    COUNT(*) as null_predictions
FROM (
    SELECT
        id,
        anofox_statistics_fit_predict_wls(
            y,
            [x],
            w,
            MAP{'intercept': 1}
        ) OVER (ORDER BY id ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) as pred
    FROM wls_negative_weights
)
WHERE (pred).yhat IS NULL;
----
9

# Test 4: Zero weights (invalid - should return NULL)
statement ok
CREATE TABLE wls_zero_weights AS
SELECT
    i as id,
    i::DOUBLE as x,
    CASE WHEN i <= 5 THEN (i * 2.0)::DOUBLE ELSE NULL END as y,
    CASE WHEN i = 2 THEN 0.0 ELSE 1.0 END::DOUBLE as w
FROM range(1, 9) t(i);

query I
SELECT
    COUNT(*) as null_predictions
FROM (
    SELECT
        id,
        anofox_statistics_fit_predict_wls(
            y,
            [x],
            w,
            MAP{'intercept': 1}
        ) OVER (ORDER BY id ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) as pred
    FROM wls_zero_weights
)
WHERE (pred).yhat IS NULL;
----
9

# Test 5: NULL weights (should default to 1.0)
statement ok
CREATE TABLE wls_null_weights AS
SELECT
    i as id,
    i::DOUBLE as x,
    CASE WHEN i <= 5 THEN (i * 2.0)::DOUBLE ELSE NULL END as y,
    CASE WHEN i % 2 = 0 THEN NULL ELSE 1.0 END::DOUBLE as w
FROM range(1, 9) t(i);

query I
SELECT
    COUNT(*) as predictions
FROM (
    SELECT
        id,
        anofox_statistics_fit_predict_wls(
            y,
            [x],
            w,
            MAP{'intercept': 1}
        ) OVER (ORDER BY id ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) as pred
    FROM wls_null_weights
)
WHERE (pred).yhat IS NOT NULL;
----
9

# Test 6: Empty feature array
statement ok
CREATE TABLE wls_empty AS
SELECT
    i as id,
    CASE WHEN i <= 4 THEN (i * 2.0)::DOUBLE ELSE NULL END as y,
    []::DOUBLE[] as x_empty,
    1.0::DOUBLE as w
FROM range(1, 7) t(i);

query I
SELECT
    COUNT(*) as null_predictions
FROM (
    SELECT
        id,
        anofox_statistics_fit_predict_wls(
            y,
            x_empty,
            w,
            MAP{'intercept': 1}
        ) OVER (ORDER BY id ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) as pred
    FROM wls_empty
)
WHERE (pred).yhat IS NULL;
----
7

# Test 7: NULL values in feature arrays
statement ok
CREATE TABLE wls_null_features AS
SELECT
    i as id,
    CASE WHEN i <= 5 THEN (i * 2.0)::DOUBLE ELSE NULL END as y,
    CASE WHEN i % 2 = 0 THEN [i::DOUBLE, NULL] ELSE [i::DOUBLE, (i * 0.5)::DOUBLE] END as x,
    1.0::DOUBLE as w
FROM range(1, 9) t(i);

query I
SELECT
    COUNT(*) as has_predictions
FROM (
    SELECT
        id,
        anofox_statistics_fit_predict_wls(
            y,
            x,
            w,
            MAP{'intercept': 1}
        ) OVER (ORDER BY id ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) as pred
    FROM wls_null_features
)
WHERE (pred).yhat IS NOT NULL;
----
4

# Test 8: Single training observation
statement ok
CREATE TABLE wls_single AS
SELECT
    i as id,
    i::DOUBLE as x,
    CASE WHEN i = 1 THEN 5.0 ELSE NULL END as y,
    1.0::DOUBLE as w
FROM range(1, 6) t(i);

query I
SELECT
    COUNT(*) as null_predictions
FROM (
    SELECT
        id,
        anofox_statistics_fit_predict_wls(
            y,
            [x],
            w,
            MAP{'intercept': 1}
        ) OVER (ORDER BY id ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) as pred
    FROM wls_single
)
WHERE (pred).yhat IS NULL;
----
6

# Test 9: Extreme weight variations
statement ok
CREATE TABLE wls_extreme_weights AS
SELECT
    i as id,
    i::DOUBLE as x,
    CASE WHEN i <= 5 THEN (i * 2.0)::DOUBLE ELSE NULL END as y,
    CASE WHEN i = 1 THEN 1000000.0 ELSE 1.0 END::DOUBLE as w
FROM range(1, 9) t(i);

query I
SELECT
    COUNT(*) as predictions
FROM (
    SELECT
        id,
        anofox_statistics_fit_predict_wls(
            y,
            [x],
            w,
            MAP{'intercept': 1}
        ) OVER (ORDER BY id ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) as pred
    FROM wls_extreme_weights
)
WHERE (pred).yhat IS NOT NULL AND NOT ISINF((pred).yhat) AND NOT ISNAN((pred).yhat);
----
9

# Test 10: PARTITION BY with insufficient data in some partitions
statement ok
CREATE TABLE wls_partitions AS
SELECT
    i as id,
    group_id,
    i::DOUBLE as x,
    CASE
        WHEN group_id = 'A' AND i <= 5 THEN (i * 2.0)::DOUBLE
        WHEN group_id = 'B' AND i <= 1 THEN (i * 3.0)::DOUBLE
        ELSE NULL
    END as y,
    1.0::DOUBLE as w
FROM range(1, 8) t(i),
     (VALUES ('A'), ('B')) g(group_id);

query II
SELECT
    group_id,
    COUNT(*) as predictions
FROM (
    SELECT
        group_id,
        id,
        anofox_statistics_fit_predict_wls(
            y,
            [x],
            w,
            MAP{'intercept': 1}
        ) OVER (PARTITION BY group_id) as pred
    FROM wls_partitions
)
WHERE (pred).yhat IS NOT NULL
GROUP BY group_id
ORDER BY group_id;
----
A	7

# Cleanup
statement ok
DROP TABLE wls_insufficient;

statement ok
DROP TABLE wls_all_null;

statement ok
DROP TABLE wls_negative_weights;

statement ok
DROP TABLE wls_zero_weights;

statement ok
DROP TABLE wls_null_weights;

statement ok
DROP TABLE wls_empty;

statement ok
DROP TABLE wls_null_features;

statement ok
DROP TABLE wls_single;

statement ok
DROP TABLE wls_extreme_weights;

statement ok
DROP TABLE wls_partitions;
