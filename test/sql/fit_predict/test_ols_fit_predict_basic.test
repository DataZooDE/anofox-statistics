# name: test/sql/fit_predict/test_ols_fit_predict_basic.test
# description: Test basic OLS fit-predict functionality
# group: [fit_predict]

require anofox_statistics

# Test 1: OLS fit-predict basic setup
statement ok
CREATE TABLE ols_data AS
SELECT
    CASE WHEN i <= 6 THEN (i * 2.0 + 1.0)::DOUBLE ELSE NULL END as y,
    i::DOUBLE as x1,
    i as id
FROM range(1, 11) t(i);

# Test 2: OLS fit-predict returns predictions
query I
SELECT
    COUNT(*) as valid_predictions
FROM (
    SELECT
        id,
        anofox_stats_ols_fit_predict(y, [x1]) OVER (ORDER BY id) as pred
    FROM ols_data
)
WHERE (pred).yhat IS NOT NULL;
----
8

# Test 3: Predictions for training rows are non-null after enough data
query I
SELECT
    COUNT(*) as non_null_count
FROM (
    SELECT
        id,
        anofox_stats_ols_fit_predict(y, [x1]) OVER (ORDER BY id) as pred
    FROM ols_data
)
WHERE id > 2 AND (pred).yhat IS NOT NULL;
----
8

# Test 4: All prediction intervals have upper >= lower when not null
query I
SELECT
    COUNT(*) as valid_intervals
FROM (
    SELECT
        id,
        (pred).yhat_lower as lower,
        (pred).yhat_upper as upper
    FROM (
        SELECT
            id,
            anofox_stats_ols_fit_predict(y, [x1]) OVER (ORDER BY id) as pred
        FROM ols_data
    )
)
WHERE lower IS NOT NULL AND upper IS NOT NULL AND upper >= lower;
----
8

# Test 5: OLS without intercept works
query I
SELECT
    COUNT(*) as predictions
FROM (
    SELECT
        id,
        anofox_stats_ols_fit_predict(y, [x1], {'intercept': 0.0}) OVER (ORDER BY id) as pred
    FROM ols_data
)
WHERE (pred).yhat IS NOT NULL;
----
9

# Cleanup
statement ok
DROP TABLE ols_data;
