# name: test/sql/fit_predict/test_rls_fit_predict_rolling.test
# description: Test RLS fit-predict with rolling windows
# group: [fit_predict]

require anofox_statistics

statement ok
CREATE TABLE rls_ts AS
SELECT
    i as time_id,
    i::DOUBLE as x,
    (i * 2.0 + random() * 0.5)::DOUBLE as y
FROM range(1, 16) t(i);

# Test 1: Expanding window (perfect for RLS - sequential learning)
query I
SELECT
    COUNT(*) as predictions
FROM (
    SELECT
        time_id,
        anofox_statistics_fit_predict_rls(
            y, [x], MAP{'intercept': 1, 'forgetting_factor': 0.99}
        ) OVER (ORDER BY time_id ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) as pred
    FROM rls_ts
)
WHERE (pred).yhat IS NOT NULL;
----
15

# Test 2: Fixed-size rolling window with adaptive tracking
query I
SELECT
    COUNT(*) as predictions
FROM (
    SELECT
        time_id,
        anofox_statistics_fit_predict_rls(
            y, [x], MAP{'intercept': 1, 'forgetting_factor': 0.95}
        ) OVER (ORDER BY time_id ROWS BETWEEN 4 PRECEDING AND CURRENT ROW) as pred
    FROM rls_ts
)
WHERE (pred).yhat IS NOT NULL;
----
15

# Test 3: ORDER BY with PARTITION BY for multiple time series
statement ok
CREATE TABLE rls_multi_series AS
SELECT
    series_id,
    t as time_id,
    t::DOUBLE as x,
    (t * series_mult + random() * 0.3)::DOUBLE as y
FROM range(1, 11) r(t),
     (VALUES ('A', 2.0), ('B', 3.0)) s(series_id, series_mult);

query II
SELECT
    series_id,
    COUNT(*) as predictions
FROM (
    SELECT
        series_id,
        time_id,
        anofox_statistics_fit_predict_rls(
            y, [x], MAP{'intercept': 1, 'forgetting_factor': 1.0}
        ) OVER (PARTITION BY series_id ORDER BY time_id ROWS BETWEEN 3 PRECEDING AND CURRENT ROW) as pred
    FROM rls_multi_series
)
WHERE (pred).yhat IS NOT NULL
GROUP BY series_id
ORDER BY series_id;
----
A	10
B	10

statement ok
DROP TABLE rls_ts;

statement ok
DROP TABLE rls_multi_series;
