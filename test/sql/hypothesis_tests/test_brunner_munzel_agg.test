# name: test/sql/hypothesis_tests/test_brunner_munzel_agg.test
# description: Test brunner_munzel_agg aggregate function
# group: [hypothesis_tests]

require anofox_statistics

# =============================================================================
# SETUP: Create test data from R example
# =============================================================================

statement ok
CREATE TABLE bm_data AS
SELECT * FROM (VALUES
    (1.0, 0), (2.0, 0), (1.0, 0), (1.0, 0), (1.0, 0), (1.0, 0), (1.0, 0), (1.0, 0), (1.0, 0), (1.0, 0), (2.0, 0), (4.0, 0),
    (3.0, 1), (3.0, 1), (4.0, 1), (3.0, 1), (1.0, 1), (2.0, 1), (3.0, 1), (1.0, 1), (1.0, 1), (5.0, 1), (4.0, 1)
) AS t(value, grp);

# =============================================================================
# TEST 1: Basic Brunner-Munzel returns valid result structure
# =============================================================================

query I
SELECT (brunner_munzel_agg(value, grp)).statistic IS NOT NULL FROM bm_data;
----
true

query I
SELECT (brunner_munzel_agg(value, grp)).p_value IS NOT NULL FROM bm_data;
----
true

query I
SELECT (brunner_munzel_agg(value, grp)).df IS NOT NULL FROM bm_data;
----
true

query I
SELECT (brunner_munzel_agg(value, grp)).effect_size IS NOT NULL FROM bm_data;
----
true

query I
SELECT (brunner_munzel_agg(value, grp)).ci_lower IS NOT NULL FROM bm_data;
----
true

query I
SELECT (brunner_munzel_agg(value, grp)).ci_upper IS NOT NULL FROM bm_data;
----
true

query I
SELECT (brunner_munzel_agg(value, grp)).n1 IS NOT NULL FROM bm_data;
----
true

query I
SELECT (brunner_munzel_agg(value, grp)).n2 IS NOT NULL FROM bm_data;
----
true

query I
SELECT (brunner_munzel_agg(value, grp)).method IS NOT NULL FROM bm_data;
----
true

# =============================================================================
# TEST 2: Significant difference detected
# =============================================================================

query I
SELECT (brunner_munzel_agg(value, grp)).p_value < 0.05 FROM bm_data;
----
true

# =============================================================================
# TEST 3: Sample sizes correct
# =============================================================================

query II
SELECT (brunner_munzel_agg(value, grp)).n1, (brunner_munzel_agg(value, grp)).n2 FROM bm_data;
----
12	11

# =============================================================================
# TEST 4: Effect size (relative effect) between 0 and 1
# =============================================================================

query I
SELECT (brunner_munzel_agg(value, grp)).effect_size BETWEEN 0 AND 1 FROM bm_data;
----
true

# =============================================================================
# TEST 5: No significant difference
# =============================================================================

statement ok
CREATE TABLE no_diff AS
SELECT * FROM (VALUES
    (1.0, 0), (2.0, 0), (3.0, 0), (4.0, 0), (5.0, 0),
    (1.5, 1), (2.5, 1), (3.5, 1), (4.5, 1), (5.5, 1)
) AS t(value, grp);

query I
SELECT (brunner_munzel_agg(value, grp)).p_value > 0.05 FROM no_diff;
----
true

# =============================================================================
# TEST 6: GROUP BY partitioning
# =============================================================================

statement ok
CREATE TABLE grouped_data AS
SELECT * FROM (VALUES
    ('A', 1.0, 0), ('A', 2.0, 0), ('A', 3.0, 0), ('A', 4.0, 0), ('A', 5.0, 0), ('A', 6.0, 0),
    ('A', 4.0, 1), ('A', 5.0, 1), ('A', 6.0, 1), ('A', 7.0, 1), ('A', 8.0, 1), ('A', 9.0, 1),
    ('B', 1.0, 0), ('B', 2.0, 0), ('B', 3.0, 0), ('B', 4.0, 0), ('B', 5.0, 0), ('B', 6.0, 0),
    ('B', 1.5, 1), ('B', 2.5, 1), ('B', 3.5, 1), ('B', 4.5, 1), ('B', 5.5, 1), ('B', 6.5, 1)
) AS t(category, value, grp);

query TI
SELECT category, (brunner_munzel_agg(value, grp)).p_value < 0.05 AS significant
FROM grouped_data
GROUP BY category
ORDER BY category;
----
A	true
B	false

# =============================================================================
# TEST 7: Alias verification (anofox_stats_brunner_munzel_agg)
# =============================================================================

query I
SELECT (anofox_stats_brunner_munzel_agg(value, grp)).statistic IS NOT NULL FROM bm_data;
----
true

# =============================================================================
# CLEANUP
# =============================================================================

statement ok
DROP TABLE IF EXISTS bm_data;

statement ok
DROP TABLE IF EXISTS no_diff;

statement ok
DROP TABLE IF EXISTS grouped_data;
