# name: test/sql/hypothesis_tests/test_kruskal_wallis_agg.test
# description: Test kruskal_wallis_agg aggregate function
# group: [hypothesis_tests]

require anofox_statistics

# =============================================================================
# SETUP: Create test data with three groups
# =============================================================================

statement ok
CREATE TABLE three_groups AS
SELECT * FROM (VALUES
    (5.2, 0), (4.8, 0), (5.1, 0), (4.9, 0), (5.0, 0),
    (3.1, 1), (3.3, 1), (3.0, 1), (3.2, 1), (3.4, 1),
    (4.1, 2), (4.3, 2), (4.0, 2), (4.2, 2), (4.4, 2)
) AS t(value, grp);

# =============================================================================
# TEST 1: Basic Kruskal-Wallis returns valid result structure
# =============================================================================

query I
SELECT (kruskal_wallis_agg(value, grp)).statistic IS NOT NULL FROM three_groups;
----
true

query I
SELECT (kruskal_wallis_agg(value, grp)).p_value IS NOT NULL FROM three_groups;
----
true

query I
SELECT (kruskal_wallis_agg(value, grp)).df IS NOT NULL FROM three_groups;
----
true

query I
SELECT (kruskal_wallis_agg(value, grp)).n IS NOT NULL FROM three_groups;
----
true

query I
SELECT (kruskal_wallis_agg(value, grp)).method IS NOT NULL FROM three_groups;
----
true

# =============================================================================
# TEST 2: Significant difference between groups
# =============================================================================

query I
SELECT (kruskal_wallis_agg(value, grp)).p_value < 0.05 FROM three_groups;
----
true

# H statistic should be large for significant effect
query I
SELECT (kruskal_wallis_agg(value, grp)).statistic > 5 FROM three_groups;
----
true

# =============================================================================
# TEST 3: Degrees of freedom = k - 1
# =============================================================================

query I
SELECT (kruskal_wallis_agg(value, grp)).df = 2 FROM three_groups;
----
true

# =============================================================================
# TEST 4: Sample size tracking
# =============================================================================

query I
SELECT (kruskal_wallis_agg(value, grp)).n = 15 FROM three_groups;
----
true

# =============================================================================
# TEST 5: No significant difference (overlapping groups)
# =============================================================================

statement ok
CREATE TABLE no_diff AS
SELECT * FROM (VALUES
    (4.0, 0), (5.0, 0), (4.5, 0), (4.8, 0),
    (4.1, 1), (5.1, 1), (4.6, 1), (4.9, 1),
    (4.0, 2), (4.9, 2), (4.4, 2), (4.7, 2)
) AS t(value, grp);

query I
SELECT (kruskal_wallis_agg(value, grp)).p_value > 0.05 FROM no_diff;
----
true

# =============================================================================
# TEST 6: Four groups
# =============================================================================

statement ok
CREATE TABLE four_groups AS
SELECT * FROM (VALUES
    (10.0, 0), (12.0, 0), (11.0, 0),
    (20.0, 1), (22.0, 1), (21.0, 1),
    (15.0, 2), (17.0, 2), (16.0, 2),
    (25.0, 3), (27.0, 3), (26.0, 3)
) AS t(value, grp);

query I
SELECT (kruskal_wallis_agg(value, grp)).df = 3 FROM four_groups;
----
true

# =============================================================================
# TEST 7: GROUP BY partitioning
# =============================================================================

statement ok
CREATE TABLE grouped_data AS
SELECT * FROM (VALUES
    ('A', 10.0, 0), ('A', 12.0, 0), ('A', 11.0, 0),
    ('A', 20.0, 1), ('A', 22.0, 1), ('A', 21.0, 1),
    ('A', 15.0, 2), ('A', 17.0, 2), ('A', 16.0, 2),
    ('B', 5.0, 0), ('B', 6.0, 0), ('B', 5.5, 0),
    ('B', 5.1, 1), ('B', 6.1, 1), ('B', 5.6, 1),
    ('B', 5.0, 2), ('B', 6.0, 2), ('B', 5.5, 2)
) AS t(category, value, grp);

query TI
SELECT category, (kruskal_wallis_agg(value, grp)).p_value < 0.05 AS significant
FROM grouped_data
GROUP BY category
ORDER BY category;
----
A	true
B	false

# =============================================================================
# TEST 8: Tied values handling
# =============================================================================

statement ok
CREATE TABLE tied_data AS
SELECT * FROM (VALUES
    (1.0, 0), (2.0, 0), (2.0, 0), (3.0, 0),
    (3.0, 1), (4.0, 1), (4.0, 1), (5.0, 1),
    (5.0, 2), (6.0, 2), (6.0, 2), (7.0, 2)
) AS t(value, grp);

query I
SELECT (kruskal_wallis_agg(value, grp)).statistic IS NOT NULL FROM tied_data;
----
true

# =============================================================================
# TEST 9: Single group returns NULL
# =============================================================================

statement ok
CREATE TABLE single_group AS
SELECT * FROM (VALUES
    (10.0, 0), (11.0, 0), (12.0, 0), (13.0, 0)
) AS t(value, grp);

query I
SELECT kruskal_wallis_agg(value, grp) IS NULL FROM single_group;
----
true

# =============================================================================
# TEST 10: Alias verification (anofox_stats_kruskal_wallis_agg)
# =============================================================================

query I
SELECT (anofox_stats_kruskal_wallis_agg(value, grp)).statistic IS NOT NULL FROM three_groups;
----
true

# =============================================================================
# CLEANUP
# =============================================================================

statement ok
DROP TABLE IF EXISTS three_groups;

statement ok
DROP TABLE IF EXISTS no_diff;

statement ok
DROP TABLE IF EXISTS four_groups;

statement ok
DROP TABLE IF EXISTS grouped_data;

statement ok
DROP TABLE IF EXISTS tied_data;

statement ok
DROP TABLE IF EXISTS single_group;
