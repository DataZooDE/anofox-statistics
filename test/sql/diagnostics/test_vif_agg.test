# name: test/sql/diagnostics/test_vif_agg.test
# description: Test vif_agg aggregate function (Variance Inflation Factor)
# group: [diagnostics]

require anofox_statistics

# =============================================================================
# SETUP: Create data with varying multicollinearity
# vif_agg(X DOUBLE[]) -> LIST(DOUBLE)
# Returns a list of VIF values for each feature
# =============================================================================

# Low multicollinearity (independent predictors)
statement ok
CREATE TABLE low_mc AS
SELECT * FROM (VALUES
    (1.0, 5.0, 9.0, 15.0),
    (2.0, 3.0, 7.0, 12.0),
    (3.0, 8.0, 2.0, 13.0),
    (4.0, 1.0, 6.0, 11.0),
    (5.0, 9.0, 4.0, 18.0),
    (6.0, 2.0, 8.0, 16.0),
    (7.0, 7.0, 3.0, 17.0),
    (8.0, 4.0, 5.0, 17.0),
    (9.0, 6.0, 1.0, 16.0),
    (10.0, 10.0, 10.0, 30.0)
) AS t(x1, x2, x3, y);

# High multicollinearity (x2 â‰ˆ 2*x1)
statement ok
CREATE TABLE high_mc AS
SELECT * FROM (VALUES
    (1.0, 2.1, 5.0, 10.0),
    (2.0, 4.0, 6.0, 14.0),
    (3.0, 6.1, 7.0, 19.0),
    (4.0, 7.9, 8.0, 22.0),
    (5.0, 10.0, 9.0, 27.0),
    (6.0, 12.1, 10.0, 32.0),
    (7.0, 13.9, 11.0, 35.0),
    (8.0, 16.0, 12.0, 40.0),
    (9.0, 18.1, 13.0, 45.0),
    (10.0, 19.9, 14.0, 48.0)
) AS t(x1, x2, x3, y);

# =============================================================================
# TEST 1: VIF returns valid list
# =============================================================================

query I
SELECT vif_agg([x1, x2, x3]) IS NOT NULL FROM low_mc;
----
true

# =============================================================================
# TEST 2: Correct number of VIF values (one per feature)
# =============================================================================

query I
SELECT len(vif_agg([x1, x2, x3])) = 3 FROM low_mc;
----
true

query I
SELECT len(vif_agg([x1, x2])) = 2 FROM low_mc;
----
true

# =============================================================================
# TEST 3: VIF values always >= 1
# =============================================================================

query I
SELECT list_min(vif_agg([x1, x2, x3])) >= 1.0 FROM low_mc;
----
true

# =============================================================================
# TEST 4: Low multicollinearity (VIF < 5)
# =============================================================================

query I
SELECT list_max(vif_agg([x1, x2, x3])) < 5 FROM low_mc;
----
true

# =============================================================================
# TEST 5: High multicollinearity detection (VIF > 5)
# =============================================================================

query I
SELECT list_max(vif_agg([x1, x2, x3])) > 5 FROM high_mc;
----
true

# =============================================================================
# TEST 6: GROUP BY partitioning
# =============================================================================

statement ok
CREATE TABLE grouped_data AS
SELECT * FROM (VALUES
    ('low', 1.0, 5.0, 9.0), ('low', 2.0, 3.0, 7.0), ('low', 3.0, 8.0, 2.0),
    ('low', 4.0, 1.0, 6.0), ('low', 5.0, 9.0, 4.0),
    ('high', 1.0, 2.1, 5.0), ('high', 2.0, 4.0, 6.0), ('high', 3.0, 6.1, 7.0),
    ('high', 4.0, 7.9, 8.0), ('high', 5.0, 10.0, 9.0)
) AS t(category, x1, x2, x3);

query TI
SELECT category, list_max(vif_agg([x1, x2, x3])) < 5 AS low_multicollinearity
FROM grouped_data
GROUP BY category
ORDER BY category;
----
high	false
low	true

# =============================================================================
# TEST 7: Alias verification
# =============================================================================

query I
SELECT anofox_stats_vif_agg([x1, x2, x3]) IS NOT NULL FROM low_mc;
----
true

# =============================================================================
# CLEANUP
# =============================================================================

statement ok
DROP TABLE IF EXISTS low_mc;

statement ok
DROP TABLE IF EXISTS high_mc;

statement ok
DROP TABLE IF EXISTS grouped_data;
