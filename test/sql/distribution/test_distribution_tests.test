# name: test/sql/distribution/test_distribution_tests.test
# description: Test distribution comparison aggregate functions (Energy Distance, MMD)
# group: [distribution]

require anofox_statistics

# =============================================================================
# ENERGY DISTANCE TEST
# Returns STRUCT with: statistic, p_value, n1, n2, method
# =============================================================================

statement ok
CREATE TABLE energy_data AS
SELECT * FROM (VALUES
    (1.0, 0), (2.0, 0), (3.0, 0), (4.0, 0), (5.0, 0),
    (1.5, 0), (2.5, 0), (3.5, 0), (4.5, 0), (5.5, 0),
    (10.0, 1), (11.0, 1), (12.0, 1), (13.0, 1), (14.0, 1),
    (10.5, 1), (11.5, 1), (12.5, 1), (13.5, 1), (14.5, 1)
) AS t(value, grp);

# TEST 1: Energy distance returns valid result structure
query I
SELECT (energy_distance_agg(value, grp)).statistic IS NOT NULL FROM energy_data;
----
true

query I
SELECT (energy_distance_agg(value, grp)).p_value IS NOT NULL FROM energy_data;
----
true

query I
SELECT (energy_distance_agg(value, grp)).n1 IS NOT NULL FROM energy_data;
----
true

query I
SELECT (energy_distance_agg(value, grp)).n2 IS NOT NULL FROM energy_data;
----
true

query I
SELECT (energy_distance_agg(value, grp)).method IS NOT NULL FROM energy_data;
----
true

# TEST 2: Sample sizes correct
query II
SELECT (energy_distance_agg(value, grp)).n1, (energy_distance_agg(value, grp)).n2 FROM energy_data;
----
10	10

# TEST 3: Statistic is non-negative
query I
SELECT (energy_distance_agg(value, grp)).statistic >= 0 FROM energy_data;
----
true

# TEST 4: Different distributions detected (p < 0.05)
query I
SELECT (energy_distance_agg(value, grp)).p_value < 0.05 FROM energy_data;
----
true

# TEST 5: Same distribution (low energy distance)
statement ok
CREATE TABLE same_dist AS
SELECT * FROM (VALUES
    (1.0, 0), (2.0, 0), (3.0, 0), (4.0, 0), (5.0, 0),
    (1.5, 0), (2.5, 0), (3.5, 0), (4.5, 0), (5.5, 0),
    (1.2, 1), (2.2, 1), (3.2, 1), (4.2, 1), (5.2, 1),
    (1.3, 1), (2.3, 1), (3.3, 1), (4.3, 1), (5.3, 1)
) AS t(value, grp);

query I
SELECT (energy_distance_agg(value, grp)).p_value > 0.05 FROM same_dist;
----
true

# TEST 6: Alias verification
query I
SELECT (anofox_stats_energy_distance_agg(value, grp)).statistic IS NOT NULL FROM energy_data;
----
true

# =============================================================================
# MAXIMUM MEAN DISCREPANCY (MMD) TEST
# Returns STRUCT with: statistic, p_value, n1, n2, method
# =============================================================================

# TEST 7: MMD returns valid result structure
query I
SELECT (mmd_agg(value, grp)).statistic IS NOT NULL FROM energy_data;
----
true

query I
SELECT (mmd_agg(value, grp)).p_value IS NOT NULL FROM energy_data;
----
true

query I
SELECT (mmd_agg(value, grp)).n1 IS NOT NULL FROM energy_data;
----
true

query I
SELECT (mmd_agg(value, grp)).n2 IS NOT NULL FROM energy_data;
----
true

query I
SELECT (mmd_agg(value, grp)).method IS NOT NULL FROM energy_data;
----
true

# TEST 8: Sample sizes correct
query II
SELECT (mmd_agg(value, grp)).n1, (mmd_agg(value, grp)).n2 FROM energy_data;
----
10	10

# TEST 9: Statistic non-negative
query I
SELECT (mmd_agg(value, grp)).statistic >= 0 FROM energy_data;
----
true

# TEST 10: Different distributions detected (p < 0.05)
query I
SELECT (mmd_agg(value, grp)).p_value < 0.05 FROM energy_data;
----
true

# TEST 11: Same distribution (high p-value)
query I
SELECT (mmd_agg(value, grp)).p_value > 0.05 FROM same_dist;
----
true

# TEST 12: Custom kernel bandwidth
query I
SELECT (mmd_agg(value, grp, {'sigma': 1.0})).statistic IS NOT NULL FROM energy_data;
----
true

# TEST 13: Alias verification
query I
SELECT (anofox_stats_mmd_agg(value, grp)).statistic IS NOT NULL FROM energy_data;
----
true

# =============================================================================
# GROUP BY PARTITIONING
# =============================================================================

statement ok
CREATE TABLE grouped_data AS
SELECT * FROM (VALUES
    ('diff', 1.0, 0), ('diff', 2.0, 0), ('diff', 3.0, 0), ('diff', 4.0, 0), ('diff', 5.0, 0),
    ('diff', 10.0, 1), ('diff', 11.0, 1), ('diff', 12.0, 1), ('diff', 13.0, 1), ('diff', 14.0, 1),
    ('same', 1.0, 0), ('same', 2.0, 0), ('same', 3.0, 0), ('same', 4.0, 0), ('same', 5.0, 0),
    ('same', 1.1, 1), ('same', 2.1, 1), ('same', 3.1, 1), ('same', 4.1, 1), ('same', 5.1, 1)
) AS t(category, value, grp);

query TI
SELECT category, (energy_distance_agg(value, grp)).p_value < 0.05 AS different_dist
FROM grouped_data
GROUP BY category
ORDER BY category;
----
diff	true
same	false

# =============================================================================
# CLEANUP
# =============================================================================

statement ok
DROP TABLE IF EXISTS energy_data;

statement ok
DROP TABLE IF EXISTS same_dist;

statement ok
DROP TABLE IF EXISTS grouped_data;
