# name: test/sql/ols_validation.test
# description: OLS regression validation tests (validated against R statistical computing)
# group: [sql]

require anofox_statistics

# Test 1: Simple Linear Regression with Intercept
# Data: y = [2.1, 4.2, 5.9, 8.1, 10.0], x = [1, 2, 3, 4, 5]
# Expected: intercept=0.15, slope=1.97, R²=0.9989, RMSE≈0.120
query RRRRR
SELECT
    round((result).intercept, 10) as intercept,
    round((result).coefficients[1], 10) as slope,
    round((result).r_squared, 10) as r2,
    round((result).adj_r_squared, 10) as adj_r2,
    round((result).residual_std_error, 5) as rmse
FROM (
    SELECT anofox_stats_ols_fit(
        [2.1, 4.2, 5.9, 8.1, 10.0],
        [[1.0, 2.0, 3.0, 4.0, 5.0]],
        {'intercept': true}
    ) as result
);
----
0.15	1.97	0.9988932359	0.9985243145	0.11972

# Test 1b: Verify coefficients are not aliased
query T
SELECT (result).coefficients IS NOT NULL as slopes_not_null
FROM (
    SELECT anofox_stats_ols_fit(
        [2.1, 4.2, 5.9, 8.1, 10.0],
        [[1.0, 2.0, 3.0, 4.0, 5.0]],
        {'intercept': true}
    ) as result
);
----
true

# Test 2: Multiple Regression with independent predictors
# Data from R lm(): y ~ x1 + x2 + x3
# R output: intercept=-1.264, x1=3.509, x2=0.486, x3=1.988, R²=0.9998
query RRRRR
SELECT
    round((result).intercept, 10) as intercept,
    round((result).coefficients[1], 10) as slope1,
    round((result).coefficients[2], 10) as slope2,
    round((result).coefficients[3], 10) as slope3,
    round((result).r_squared, 10) as r2
FROM (
    SELECT anofox_stats_ols_fit(
        [9.3490142459, 23.0585207096, 20.1443065614, 27.5069089569, 23.3797539876, 40.4297589129, 36.6737638447, 43.2302304187, 44.8091576842, 59.3127680131],
        [[1.0, 2.0, 3.0, 4.0, 5.0, 6.0, 7.0, 8.0, 9.0, 10.0], [5.2, 2.8, 7.1, 1.5, 9.3, 3.6, 8.4, 4.2, 6.7, 10.1], [2.3, 8.1, 3.7, 6.9, 1.4, 9.6, 4.5, 7.2, 5.8, 10.3]],
        {'intercept': true}
    ) as result
);
----
-1.2644666912	3.5092902696	0.4860377434	1.9882987012	0.9997870909

# Test 3: OLS without Intercept
# Data: y = 2*x (perfect fit, no intercept)
# Expected (from R): slope=2.0 (exact)
query R
SELECT round((result).coefficients[1], 10) as slope
FROM (
    SELECT anofox_stats_ols_fit(
        [2.0, 4.0, 6.0, 8.0, 10.0],
        [[1.0, 2.0, 3.0, 4.0, 5.0]],
        {'intercept': false}
    ) as result
);
----
2.0

# Test 3b: Verify intercept is NaN when not fitted (no intercept in model)
query T
SELECT ISNAN((result).intercept) as intercept_is_nan
FROM (
    SELECT anofox_stats_ols_fit(
        [2.0, 4.0, 6.0, 8.0, 10.0],
        [[1.0, 2.0, 3.0, 4.0, 5.0]],
        {'intercept': false}
    ) as result
);
----
true

# Test 4: Rank-Deficient (Constant Feature)
# Data: x1=[1,2,3,4,5], x2=[5,5,5,5,5] (constant), y=2*x1
# Note: Behavior with collinear features depends on implementation
query RR
SELECT
    round((result).intercept, 10) as intercept,
    round((result).coefficients[1], 10) as x1_coef
FROM (
    SELECT anofox_stats_ols_fit(
        [2.0, 4.0, 6.0, 8.0, 10.0],
        [[1.0, 2.0, 3.0, 4.0, 5.0], [5.0, 5.0, 5.0, 5.0, 5.0]],
        {'intercept': true}
    ) as result
);
----
0.0	2.0

# Test 5: Perfect Collinearity
# Data: x1=[1,2,3,4,5], x2=2*x1 (perfect collinearity), y=2*x1+1
query RR
SELECT
    round((result).intercept, 10) as intercept,
    round((result).r_squared, 10) as r2
FROM (
    SELECT anofox_stats_ols_fit(
        [3.0, 5.0, 7.0, 9.0, 11.0],
        [[1.0, 2.0, 3.0, 4.0, 5.0], [2.0, 4.0, 6.0, 8.0, 10.0]],
        {'intercept': true}
    ) as result
);
----
1.0	1.0

# Test 6: Edge Case - Exact fit with intercept
# Verify residual_std_error is very small for near-perfect fit
query T
SELECT (result).residual_std_error < 0.0001 as rmse_near_zero
FROM (
    SELECT anofox_stats_ols_fit(
        [1.0, 2.0, 3.0, 4.0, 5.0],
        [[1.0, 2.0, 3.0, 4.0, 5.0]],
        {'intercept': true}
    ) as result
);
----
true

# Test 7: Edge Case - Small sample size (n=3, minimum for OLS with intercept)
query RRR
SELECT
    round((result).intercept, 10) as intercept,
    round((result).coefficients[1], 10) as slope,
    round((result).r_squared, 10) as r2
FROM (
    SELECT anofox_stats_ols_fit(
        [2.0, 4.0, 6.0],
        [[1.0, 2.0, 3.0]],
        {'intercept': true}
    ) as result
);
----
0.0	2.0	1.0

# Test 8: Numerical Stability - Large values
query T
SELECT (result).r_squared > 0.99 as high_r2
FROM (
    SELECT anofox_stats_ols_fit(
        [1000.0, 2000.0, 3000.0, 4000.0, 5000.0],
        [[1.0, 2.0, 3.0, 4.0, 5.0]],
        {'intercept': true}
    ) as result
);
----
true

# Test 9: Verify all output fields are present and correct type
query TTTTTTT
SELECT
    (result).intercept IS NOT NULL as has_intercept,
    (result).coefficients IS NOT NULL as has_coefficients,
    (result).r_squared IS NOT NULL as has_r2,
    (result).adj_r_squared IS NOT NULL as has_adj_r2,
    (result).residual_std_error IS NOT NULL as has_rmse,
    (result).n_observations IS NOT NULL as has_n_obs,
    (result).n_features IS NOT NULL as has_n_features
FROM (
    SELECT anofox_stats_ols_fit(
        [2.1, 4.2, 5.9, 8.1, 10.0],
        [[1.0, 2.0, 3.0, 4.0, 5.0]],
        {'intercept': true}
    ) as result
);
----
true	true	true	true	true	true	true

# Test 10: High precision coefficient recovery
query T
SELECT ABS((result).coefficients[1] - 2.0) < 1e-10 as coef_match
FROM (
    SELECT anofox_stats_ols_fit(
        [3.0, 5.0, 7.0, 9.0, 11.0, 13.0, 15.0, 17.0, 19.0, 21.0,
         23.0, 25.0, 27.0, 29.0, 31.0, 33.0, 35.0, 37.0, 39.0, 41.0],
        [[1.0, 2.0, 3.0, 4.0, 5.0, 6.0, 7.0, 8.0, 9.0, 10.0,
          11.0, 12.0, 13.0, 14.0, 15.0, 16.0, 17.0, 18.0, 19.0, 20.0]]
    ) as result
);
----
true

# Test 11: High precision intercept recovery
query T
SELECT ABS((result).intercept - 1.0) < 1e-10 as intercept_match
FROM (
    SELECT anofox_stats_ols_fit(
        [3.0, 5.0, 7.0, 9.0, 11.0, 13.0, 15.0, 17.0, 19.0, 21.0,
         23.0, 25.0, 27.0, 29.0, 31.0, 33.0, 35.0, 37.0, 39.0, 41.0],
        [[1.0, 2.0, 3.0, 4.0, 5.0, 6.0, 7.0, 8.0, 9.0, 10.0,
          11.0, 12.0, 13.0, 14.0, 15.0, 16.0, 17.0, 18.0, 19.0, 20.0]]
    ) as result
);
----
true
