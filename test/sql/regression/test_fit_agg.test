# name: test/sql/regression/test_fit_agg.test
# description: Test regression fit aggregate functions (OLS, Ridge, ElasticNet, WLS, RLS)
# group: [regression]

require anofox_statistics

# =============================================================================
# SETUP: Create regression data
# =============================================================================

statement ok
CREATE TABLE reg_data AS
SELECT * FROM (VALUES
    (1.0, 2.1, 3.0, 10.5),
    (2.0, 3.2, 4.0, 15.8),
    (3.0, 4.1, 5.0, 20.2),
    (4.0, 5.3, 6.0, 26.1),
    (5.0, 6.2, 7.0, 30.5),
    (6.0, 7.1, 8.0, 35.8),
    (7.0, 8.4, 9.0, 41.2),
    (8.0, 9.2, 10.0, 46.0),
    (9.0, 10.3, 11.0, 51.5),
    (10.0, 11.1, 12.0, 56.2)
) AS t(x1, x2, x3, y);

# =============================================================================
# OLS FIT AGGREGATE TESTS
# =============================================================================

# TEST 1: OLS fit returns valid result structure
query I
SELECT (ols_fit_agg(y, [x1, x2, x3])).coefficients IS NOT NULL FROM reg_data;
----
true

query I
SELECT (ols_fit_agg(y, [x1, x2, x3])).intercept IS NOT NULL FROM reg_data;
----
true

query I
SELECT (ols_fit_agg(y, [x1, x2, x3])).r_squared IS NOT NULL FROM reg_data;
----
true

query I
SELECT (ols_fit_agg(y, [x1, x2, x3])).adj_r_squared IS NOT NULL FROM reg_data;
----
true

query I
SELECT (ols_fit_agg(y, [x1, x2, x3])).residual_std_error IS NOT NULL FROM reg_data;
----
true

query I
SELECT (ols_fit_agg(y, [x1, x2, x3])).n_observations IS NOT NULL FROM reg_data;
----
true

# TEST 2: Sample size correct
query I
SELECT (ols_fit_agg(y, [x1, x2, x3])).n_observations = 10 FROM reg_data;
----
true

# TEST 3: R-squared between 0 and 1
query I
SELECT (ols_fit_agg(y, [x1, x2, x3])).r_squared BETWEEN 0 AND 1 FROM reg_data;
----
true

# TEST 4: Good fit (high R-squared)
query I
SELECT (ols_fit_agg(y, [x1, x2, x3])).r_squared > 0.99 FROM reg_data;
----
true

# TEST 5: Alias verification
query I
SELECT (anofox_stats_ols_fit_agg(y, [x1, x2, x3])).coefficients IS NOT NULL FROM reg_data;
----
true

# =============================================================================
# RIDGE FIT AGGREGATE TESTS
# =============================================================================

# TEST 6: Ridge fit returns valid result structure
query I
SELECT (ridge_fit_agg(y, [x1, x2, x3])).coefficients IS NOT NULL FROM reg_data;
----
true

query I
SELECT (ridge_fit_agg(y, [x1, x2, x3])).intercept IS NOT NULL FROM reg_data;
----
true

query I
SELECT (ridge_fit_agg(y, [x1, x2, x3])).r_squared IS NOT NULL FROM reg_data;
----
true

query I
SELECT (ridge_fit_agg(y, [x1, x2, x3])).residual_std_error IS NOT NULL FROM reg_data;
----
true

query I
SELECT (ridge_fit_agg(y, [x1, x2, x3])).n_observations IS NOT NULL FROM reg_data;
----
true

# TEST 7: Good fit (high R-squared)
query I
SELECT (ridge_fit_agg(y, [x1, x2, x3])).r_squared > 0.95 FROM reg_data;
----
true

# TEST 8: Custom lambda parameter
query I
SELECT (ridge_fit_agg(y, [x1, x2, x3], {'lambda': 0.1})).coefficients IS NOT NULL FROM reg_data;
----
true

# TEST 9: Alias verification
query I
SELECT (anofox_stats_ridge_fit_agg(y, [x1, x2, x3])).coefficients IS NOT NULL FROM reg_data;
----
true

# =============================================================================
# ELASTICNET FIT AGGREGATE TESTS
# =============================================================================

# TEST 10: ElasticNet fit returns valid result structure
query I
SELECT (elasticnet_fit_agg(y, [x1, x2, x3])).coefficients IS NOT NULL FROM reg_data;
----
true

query I
SELECT (elasticnet_fit_agg(y, [x1, x2, x3])).intercept IS NOT NULL FROM reg_data;
----
true

query I
SELECT (elasticnet_fit_agg(y, [x1, x2, x3])).r_squared IS NOT NULL FROM reg_data;
----
true

query I
SELECT (elasticnet_fit_agg(y, [x1, x2, x3])).residual_std_error IS NOT NULL FROM reg_data;
----
true

query I
SELECT (elasticnet_fit_agg(y, [x1, x2, x3])).n_observations IS NOT NULL FROM reg_data;
----
true

# TEST 11: Good fit (R-squared is valid)
query I
SELECT (elasticnet_fit_agg(y, [x1, x2, x3])).r_squared BETWEEN 0 AND 1 FROM reg_data;
----
true

# TEST 12: Custom parameters (lambda and alpha)
query I
SELECT (elasticnet_fit_agg(y, [x1, x2, x3], {'lambda': 0.1, 'alpha': 0.5})).coefficients IS NOT NULL FROM reg_data;
----
true

# TEST 13: Alias verification
query I
SELECT (anofox_stats_elasticnet_fit_agg(y, [x1, x2, x3])).coefficients IS NOT NULL FROM reg_data;
----
true

# =============================================================================
# WLS FIT AGGREGATE TESTS
# =============================================================================

statement ok
CREATE TABLE wls_data AS
SELECT * FROM (VALUES
    (1.0, 2.1, 10.5, 1.0),
    (2.0, 3.2, 15.8, 1.0),
    (3.0, 4.1, 20.2, 2.0),
    (4.0, 5.3, 26.1, 2.0),
    (5.0, 6.2, 30.5, 3.0),
    (6.0, 7.1, 35.8, 3.0),
    (7.0, 8.4, 41.2, 4.0),
    (8.0, 9.2, 46.0, 4.0),
    (9.0, 10.3, 51.5, 5.0),
    (10.0, 11.1, 56.2, 5.0)
) AS t(x1, x2, y, weight);

# TEST 14: WLS fit returns valid result structure
query I
SELECT (wls_fit_agg(y, [x1, x2], weight)).coefficients IS NOT NULL FROM wls_data;
----
true

query I
SELECT (wls_fit_agg(y, [x1, x2], weight)).intercept IS NOT NULL FROM wls_data;
----
true

query I
SELECT (wls_fit_agg(y, [x1, x2], weight)).r_squared IS NOT NULL FROM wls_data;
----
true

query I
SELECT (wls_fit_agg(y, [x1, x2], weight)).residual_std_error IS NOT NULL FROM wls_data;
----
true

query I
SELECT (wls_fit_agg(y, [x1, x2], weight)).n_observations IS NOT NULL FROM wls_data;
----
true

# TEST 15: Good fit (high R-squared)
query I
SELECT (wls_fit_agg(y, [x1, x2], weight)).r_squared > 0.95 FROM wls_data;
----
true

# TEST 16: Alias verification
query I
SELECT (anofox_stats_wls_fit_agg(y, [x1, x2], weight)).coefficients IS NOT NULL FROM wls_data;
----
true

# =============================================================================
# RLS FIT AGGREGATE TESTS
# =============================================================================

# TEST 17: RLS fit returns valid result structure
query I
SELECT (rls_fit_agg(y, [x1, x2, x3])).coefficients IS NOT NULL FROM reg_data;
----
true

query I
SELECT (rls_fit_agg(y, [x1, x2, x3])).intercept IS NOT NULL FROM reg_data;
----
true

query I
SELECT (rls_fit_agg(y, [x1, x2, x3])).r_squared IS NOT NULL FROM reg_data;
----
true

query I
SELECT (rls_fit_agg(y, [x1, x2, x3])).residual_std_error IS NOT NULL FROM reg_data;
----
true

query I
SELECT (rls_fit_agg(y, [x1, x2, x3])).n_observations IS NOT NULL FROM reg_data;
----
true

# TEST 18: Good fit (high R-squared)
query I
SELECT (rls_fit_agg(y, [x1, x2, x3])).r_squared > 0.95 FROM reg_data;
----
true

# TEST 19: Custom forgetting factor
query I
SELECT (rls_fit_agg(y, [x1, x2, x3], {'lambda': 0.99})).coefficients IS NOT NULL FROM reg_data;
----
true

# TEST 20: Alias verification
query I
SELECT (anofox_stats_rls_fit_agg(y, [x1, x2, x3])).coefficients IS NOT NULL FROM reg_data;
----
true

# =============================================================================
# GROUP BY PARTITIONING
# =============================================================================

statement ok
CREATE TABLE grouped_reg AS
SELECT * FROM (VALUES
    ('A', 1.0, 2.0, 5.0), ('A', 2.0, 4.0, 10.0), ('A', 3.0, 6.0, 15.0),
    ('A', 4.0, 8.0, 20.0), ('A', 5.0, 10.0, 25.0),
    ('B', 1.0, 3.0, 8.0), ('B', 2.0, 6.0, 16.0), ('B', 3.0, 9.0, 24.0),
    ('B', 4.0, 12.0, 32.0), ('B', 5.0, 15.0, 40.0)
) AS t(category, x1, x2, y);

query TI
SELECT category, (ols_fit_agg(y, [x1, x2])).r_squared > 0.99 AS good_fit
FROM grouped_reg
GROUP BY category
ORDER BY category;
----
A	true
B	true

# =============================================================================
# CLEANUP
# =============================================================================

statement ok
DROP TABLE IF EXISTS reg_data;

statement ok
DROP TABLE IF EXISTS wls_data;

statement ok
DROP TABLE IF EXISTS grouped_reg;
