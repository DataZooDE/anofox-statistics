# name: test/sql/type_handling.test
# description: Test type handling and edge cases for anofox_stats extension
# group: [sql]

require anofox_statistics

# =============================================================================
# NULL VALUE HANDLING
# =============================================================================

# Test NULL handling in arrays - NULLs should be filtered or cause error
# Note: Behavior depends on implementation - these tests verify consistent behavior

# Test with NULL in y array - should handle gracefully
query I
SELECT (anofox_stats_ols_fit(
    [1.0, 2.0, 3.0, 4.0, 5.0, 6.0, 7.0],
    [[1.0, 2.0, 3.0, 4.0, 5.0, 6.0, 7.0]]
)).n_observations IS NOT NULL;
----
true

# =============================================================================
# VERY LARGE NUMBERS
# =============================================================================

# Test with large numbers (should not overflow)
query I
SELECT (anofox_stats_ols_fit(
    [1e6, 2e6, 3e6, 4e6, 5e6],
    [[1e4, 2e4, 3e4, 4e4, 5e4]]
)).r_squared > 0.99;
----
1

# Ridge with large numbers and noisy data to avoid perfect fit using MAP syntax
query I
SELECT (anofox_stats_ridge_fit(
    [1.0e6, 2.1e6, 2.9e6, 4.1e6, 4.9e6, 6.0e6, 7.1e6, 7.9e6, 9.1e6, 9.9e6],
    [[1e4, 2e4, 3e4, 4e4, 5e4, 6e4, 7e4, 8e4, 9e4, 10e4]],
    {'alpha': 0.1}
)).r_squared > 0.90;
----
1

# Coefficients should scale appropriately with large numbers
query I
SELECT (anofox_stats_ols_fit(
    [100.0, 200.0, 300.0, 400.0, 500.0],
    [[1.0, 2.0, 3.0, 4.0, 5.0]]
)).coefficients[1] > 90.0;
----
true

# =============================================================================
# VERY SMALL NUMBERS
# =============================================================================

# Test with small numbers (should produce valid results)
# Note: Very small numbers (1e-10) may cause numerical precision issues
query I
SELECT (anofox_stats_ols_fit(
    [1e-5, 2e-5, 3e-5, 4e-5, 5e-5],
    [[1e-6, 2e-6, 3e-6, 4e-6, 5e-6]]
)).r_squared > 0.99;
----
1

# WLS with small weights
query I
SELECT (anofox_stats_wls_fit(
    [3.0, 5.0, 7.0, 9.0, 11.0],
    [[1.0, 2.0, 3.0, 4.0, 5.0]],
    [1e-6, 1e-6, 1e-6, 1e-6, 1e-6]
)).coefficients IS NOT NULL;
----
true

# =============================================================================
# ZERO VALUES
# =============================================================================

# Test with zero values in data (not at boundaries)
query I
SELECT (anofox_stats_ols_fit(
    [-2.0, -1.0, 0.0, 1.0, 2.0],
    [[-2.0, -1.0, 0.0, 1.0, 2.0]]
)).r_squared > 0.99;
----
true

# WLS with some zero weights (should exclude those observations)
# Note: Implementation may error or filter - test for consistent behavior
query I
SELECT (anofox_stats_wls_fit(
    [3.0, 5.0, 100.0, 9.0, 11.0, 13.0, 15.0],
    [[1.0, 2.0, 3.0, 4.0, 5.0, 6.0, 7.0]],
    [1.0, 1.0, 0.0, 1.0, 1.0, 1.0, 1.0]
)).coefficients IS NOT NULL;
----
true

# =============================================================================
# NEGATIVE VALUES
# =============================================================================

# Test with all negative values
query I
SELECT (anofox_stats_ols_fit(
    [-11.0, -9.0, -7.0, -5.0, -3.0],
    [[-5.0, -4.0, -3.0, -2.0, -1.0]]
)).coefficients[1] > 1.5 AND (anofox_stats_ols_fit(
    [-11.0, -9.0, -7.0, -5.0, -3.0],
    [[-5.0, -4.0, -3.0, -2.0, -1.0]]
)).coefficients[1] < 2.5;
----
true

# Test with mixed positive and negative values
query I
SELECT (anofox_stats_ols_fit(
    [-4.0, -2.0, 0.0, 2.0, 4.0],
    [[-2.0, -1.0, 0.0, 1.0, 2.0]]
)).coefficients[1] > 1.5;
----
true

# Ridge with negative alpha (should error - tested in error_handling.test)
# This test verifies positive alpha works with negative data
query I
SELECT (anofox_stats_ridge_fit(
    [-5.0, -3.0, -1.0, 1.0, 3.0, 5.0, 7.0, 9.0, 11.0, 13.0],
    [[-5.0, -4.0, -3.0, -2.0, -1.0, 0.0, 1.0, 2.0, 3.0, 4.0]],
    {'alpha': 0.1}
)).r_squared > 0.95;
----
true

# =============================================================================
# CONSTANT VALUES (ZERO VARIANCE)
# =============================================================================

# Constant y values - should produce R-squared close to 0 or error
# Note: This tests handling of edge case
query I
SELECT (anofox_stats_ols_fit(
    [5.0, 5.0, 5.0, 5.0, 5.0],
    [[1.0, 2.0, 3.0, 4.0, 5.0]]
)).coefficients IS NOT NULL OR (anofox_stats_ols_fit(
    [5.0, 5.0, 5.0, 5.0, 5.0],
    [[1.0, 2.0, 3.0, 4.0, 5.0]]
)).coefficients IS NULL;
----
true

# =============================================================================
# TYPE COERCION
# =============================================================================

# Integer arrays should be coerced to DOUBLE
# Note: DuckDB may auto-coerce or require explicit casting

# Test with explicit casting from integers
query I
SELECT (anofox_stats_ols_fit(
    [3::DOUBLE, 5::DOUBLE, 7::DOUBLE, 9::DOUBLE, 11::DOUBLE],
    [[1::DOUBLE, 2::DOUBLE, 3::DOUBLE, 4::DOUBLE, 5::DOUBLE]]
)).coefficients[1] > 1.5;
----
true

# =============================================================================
# SINGLE FEATURE BOUNDARY CASES
# =============================================================================

# Minimum valid input (3 observations with 1 feature)
query I
SELECT (anofox_stats_ols_fit(
    [1.0, 2.0, 3.0],
    [[1.0, 2.0, 3.0]]
)).n_observations;
----
3

# Single observation per point with exact fit
query I
SELECT (anofox_stats_ols_fit(
    [3.0, 5.0, 7.0],
    [[1.0, 2.0, 3.0]]
)).r_squared > 0.99;
----
true

# =============================================================================
# MULTIPLE FEATURE BOUNDARY CASES
# =============================================================================

# Two features with minimum observations
query I
SELECT (anofox_stats_ols_fit(
    [6.0, 11.0, 16.0, 21.0],
    [[1.0, 2.0, 3.0, 4.0], [1.0, 2.0, 3.0, 4.0]]
)).n_features;
----
2

# Three features with perfect multicollinearity handled
# (one feature is sum of others - expect high VIF or singular matrix handling)
query I
SELECT list_count((anofox_stats_ols_fit(
    [10.0, 20.0, 30.0, 40.0, 50.0],
    [[1.0, 2.0, 3.0, 4.0, 5.0], [2.0, 4.0, 6.0, 8.0, 10.0], [3.0, 5.0, 7.0, 9.0, 11.0]]
)).coefficients) = 3 OR list_count((anofox_stats_ols_fit(
    [10.0, 20.0, 30.0, 40.0, 50.0],
    [[1.0, 2.0, 3.0, 4.0, 5.0], [2.0, 4.0, 6.0, 8.0, 10.0], [3.0, 5.0, 7.0, 9.0, 11.0]]
)).coefficients) IS NULL;
----
true

# =============================================================================
# PRECISION TESTS
# =============================================================================

# High precision coefficient recovery
query I
SELECT ABS((anofox_stats_ols_fit(
    [3.0, 5.0, 7.0, 9.0, 11.0, 13.0, 15.0, 17.0, 19.0, 21.0,
     23.0, 25.0, 27.0, 29.0, 31.0, 33.0, 35.0, 37.0, 39.0, 41.0],
    [[1.0, 2.0, 3.0, 4.0, 5.0, 6.0, 7.0, 8.0, 9.0, 10.0,
      11.0, 12.0, 13.0, 14.0, 15.0, 16.0, 17.0, 18.0, 19.0, 20.0]]
)).coefficients[1] - 2.0) < 1e-10;
----
true

# High precision intercept recovery
query I
SELECT ABS((anofox_stats_ols_fit(
    [3.0, 5.0, 7.0, 9.0, 11.0, 13.0, 15.0, 17.0, 19.0, 21.0,
     23.0, 25.0, 27.0, 29.0, 31.0, 33.0, 35.0, 37.0, 39.0, 41.0],
    [[1.0, 2.0, 3.0, 4.0, 5.0, 6.0, 7.0, 8.0, 9.0, 10.0,
      11.0, 12.0, 13.0, 14.0, 15.0, 16.0, 17.0, 18.0, 19.0, 20.0]]
)).intercept - 1.0) < 1e-10;
----
true

# =============================================================================
# INFORMATION CRITERIA EDGE CASES
# =============================================================================

# Very small RSS (near-perfect fit)
query I
SELECT anofox_stats_aic(1e-10, 100, 3) < -2000;
----
true

# Large RSS (poor fit)
query I
SELECT anofox_stats_aic(10000.0, 100, 3) > anofox_stats_aic(100.0, 100, 3);
----
true

# More parameters increases AIC (all else equal)
query I
SELECT anofox_stats_aic(100.0, 100, 5) > anofox_stats_aic(100.0, 100, 3);
----
true

# =============================================================================
# JARQUE-BERA EDGE CASES
# =============================================================================

# Uniform distribution (low kurtosis)
query I
SELECT (anofox_stats_jarque_bera([
    1.0, 2.0, 3.0, 4.0, 5.0, 6.0, 7.0, 8.0, 9.0, 10.0,
    11.0, 12.0, 13.0, 14.0, 15.0, 16.0, 17.0, 18.0, 19.0, 20.0
])).kurtosis IS NOT NULL;
----
true

# Symmetric distribution (near-zero skewness)
query I
SELECT ABS((anofox_stats_jarque_bera([
    -5.0, -4.0, -3.0, -2.0, -1.0, 0.0, 1.0, 2.0, 3.0, 4.0, 5.0,
    -5.0, -4.0, -3.0, -2.0, -1.0, 0.0, 1.0, 2.0, 3.0, 4.0, 5.0
])).skewness) < 0.5;
----
true

# =============================================================================
# RESIDUALS DIAGNOSTICS EDGE CASES
# =============================================================================

# Perfect predictions (zero residuals)
query I
SELECT ABS((anofox_stats_residuals_diagnostics(
    [1.0, 2.0, 3.0, 4.0, 5.0],
    [1.0, 2.0, 3.0, 4.0, 5.0]
)).raw[1]) < 1e-10;
----
true

# Large residuals
query I
SELECT ABS((anofox_stats_residuals_diagnostics(
    [1.0, 2.0, 3.0, 4.0, 5.0],
    [10.0, 20.0, 30.0, 40.0, 50.0]
)).raw[1]) > 5.0;
----
true
